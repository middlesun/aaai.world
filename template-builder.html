<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Template Builder - AI-Powered Template Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;500;600&family=Roboto+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Colors */
            --color-black-gradient-start: #000000;
            --color-black-gradient-end: #0a0a0b;
            --color-jetblack-gradient: linear-gradient(to bottom, var(--color-black-gradient-start), var(--color-black-gradient-end));
            --color-glass-background: rgba(28, 28, 30, 0.82);
            --color-glass-border: rgba(255, 255, 255, 0.08);
            --color-purple: #8353da;
            --color-purple-hover: #9567e4;
            --color-purple-active: #6f41c3;
            
            /* Shadows */
            --shadow-base: 0 1px 4px rgba(0, 0, 0, 0.4);
            --shadow-glow: 0 4px 12px rgba(131, 83, 218, 0.15);
            
            /* Blur & Effects */
            --blur-glass: blur(24px);
            --grain-opacity: 0.03;
            
            /* Typography */
            --font-inter: 'Inter', sans-serif;
            --font-code: 'Fira Code', 'SF Mono', monospace;
            --font-size-body: 15px;
            --font-size-body-max: 17px;
            --font-size-ui: 14px;
            --font-size-headline-min: 20px;
            --font-size-headline-max: 28px;
            --font-weight-regular: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --line-height-body: 1.6;
            --line-height-headline: 1.3;
            --letter-spacing-ui: 0.1px;
            
            /* Border Radius */
            --radius-base: 8px;
            
            /* Legacy compatibility */
            --aurora-cyan: var(--color-purple);
            --aurora-purple: var(--color-purple);
            --aurora-pink: var(--color-purple);
            --glass-bg: var(--color-glass-background);
            --glass-border: var(--color-glass-border);
            --glass-shadow: var(--shadow-base);
            --text-primary: rgba(255, 255, 255, 0.95);
            --text-secondary: rgba(255, 255, 255, 0.75);
            --text-muted: rgba(255, 255, 255, 0.55);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-inter);
            font-size: var(--font-size-body);
            line-height: var(--line-height-body);
            margin: 0;
            padding: 0;
            background: var(--color-jetblack-gradient);
            position: relative;
            overflow-x: hidden;
            color: var(--text-primary);
        }

        /* Aurora Background Animation */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, var(--aurora-cyan), var(--aurora-purple), var(--aurora-pink), var(--aurora-cyan));
            background-size: 400% 400%;
            animation: aurora 8s ease-in-out infinite;
            opacity: 0.15;
            z-index: -1;
        }

        @keyframes aurora {
            0%, 100% { background-position: 0% 50%; }
            25% { background-position: 100% 50%; }
            50% { background-position: 100% 100%; }
            75% { background-position: 0% 100%; }
        }

        /* Typography */
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            color: var(--text-primary);
        }

        .heading-lg { font-size: 36px; line-height: 44px; }
        .heading-md { font-size: 28px; line-height: 36px; }
        .heading-sm { font-size: 20px; line-height: 28px; }

        .mono { 
            font-family: 'Roboto Mono', monospace; 
            font-weight: 400;
        }

        /* Glass Components - New Design System */
        .glass-card {
            background: var(--color-glass-background);
            backdrop-filter: var(--blur-glass);
            border: 1px solid var(--color-glass-border);
            border-radius: var(--radius-base);
            box-shadow: var(--shadow-base);
            transition: all 0.25s ease-in-out;
            position: relative;
            overflow: hidden;
        }

        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-base), var(--shadow-glow);
        }

        .glass-card:active {
            /* Removed scale transform to prevent bounce effect */
        }

        /* Form Controls - New Design System */
        .aurora-input {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: var(--blur-glass);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: var(--radius-base);
            padding: 12px 16px;
            color: var(--text-primary);
            font-family: var(--font-inter);
            font-size: var(--font-size-body);
            transition: all 0.25s ease-in-out;
            outline: none;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .aurora-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .aurora-input:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.25);
        }

        .aurora-input:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--color-purple);
            box-shadow: var(--shadow-base), var(--shadow-glow), inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .aurora-select {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: var(--blur-glass);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: var(--radius-base);
            padding: 12px 16px;
            color: var(--text-primary);
            font-family: var(--font-inter);
            font-size: var(--font-size-body);
            transition: all 0.25s ease-in-out;
            outline: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%238353da' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            appearance: none;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .aurora-select:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.25);
        }

        .aurora-select:focus {
            background: rgba(255, 255, 255, 0.15);
            border-color: var(--color-purple);
            box-shadow: var(--shadow-base), var(--shadow-glow), inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .aurora-select option {
            background: var(--color-black-gradient-start);
            color: var(--text-primary);
        }

        /* Multi-select dropdown specific styles */
        .aurora-select[multiple] {
            background-image: none; /* Remove dropdown arrow for multi-select */
            padding: 8px 12px;
            height: auto;
            min-height: 100px;
        }

        .aurora-select[multiple] option {
            padding: 8px 12px;
            margin: 2px 0;
            border-radius: 4px;
            transition: all 0.2s ease-in-out;
        }

        .aurora-select[multiple] option:hover {
            background: rgba(131, 83, 218, 0.2);
        }

        .aurora-select[multiple] option:checked {
            background: var(--color-purple);
            color: white;
            font-weight: 500;
        }

        .aurora-select[multiple]:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(255, 255, 255, 0.05);
        }

        /* Multi-Select Container Styles */
        .multi-select-container {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: var(--blur-glass);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: var(--radius-base);
            max-height: 120px;
            overflow-y: auto;
            padding: 8px;
            transition: all 0.25s ease-in-out;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .multi-select-container:focus-within {
            border-color: var(--color-purple);
            box-shadow: var(--shadow-base), var(--shadow-glow), inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        /* Multi-Select Items */
        .multi-select-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            margin: 2px 0;
            border-radius: 4px;
            cursor: pointer;
            user-select: none;
        }

        .multi-select-item:hover {
            background: rgba(131, 83, 218, 0.1);
        }

        .multi-select-item.selected {
            background: rgba(131, 83, 218, 0.2);
            border: 1px solid var(--color-purple);
        }

        .multi-select-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            appearance: none;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 3px;
            position: relative;
            cursor: pointer;
        }

        .multi-select-item input[type="checkbox"]:checked {
            background: var(--color-purple);
            border-color: var(--color-purple);
        }

        .multi-select-item input[type="checkbox"]:checked::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 10px;
            font-weight: bold;
        }

        .multi-select-item-label {
            flex: 1;
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 400;
        }

        /* Custom Scrollbar Styles */
        .multi-select-container::-webkit-scrollbar {
            width: 6px;
        }

        .multi-select-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .multi-select-container::-webkit-scrollbar-thumb {
            background: var(--color-purple);
            border-radius: 3px;
            transition: background 0.2s ease-in-out;
        }

        .multi-select-container::-webkit-scrollbar-thumb:hover {
            background: var(--color-purple-hover);
        }

        /* Firefox scrollbar */
        .multi-select-container {
            scrollbar-width: thin;
            scrollbar-color: var(--color-purple) rgba(255, 255, 255, 0.05);
        }

        /* Textarea Scrollbar Styles */
        .aurora-input::-webkit-scrollbar {
            width: 8px;
        }

        .aurora-input::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .aurora-input::-webkit-scrollbar-thumb {
            background: var(--color-purple);
            border-radius: 4px;
            transition: background 0.2s ease-in-out;
        }

        .aurora-input::-webkit-scrollbar-thumb:hover {
            background: var(--color-purple-hover);
        }

        /* Firefox textarea scrollbar */
        .aurora-input {
            scrollbar-width: thin;
            scrollbar-color: var(--color-purple) rgba(255, 255, 255, 0.05);
        }

        /* Primary Button - New Design System */
        .aurora-button {
            background-color: var(--color-purple);
            border: none;
            border-radius: var(--radius-base);
            padding: 14px 24px;
            color: white;
            font-family: var(--font-inter);
            font-weight: var(--font-weight-medium);
            font-size: var(--font-size-ui);
            letter-spacing: var(--letter-spacing-ui);
            transition: all 0.25s ease-in-out;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-base);
            cursor: pointer;
        }

        .aurora-button:hover {
            background-color: var(--color-purple-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow-base), var(--shadow-glow);
        }

        .aurora-button:active {
            background-color: var(--color-purple-active);
            transform: scale(0.98);
            box-shadow: var(--shadow-base), var(--shadow-glow);
        }

        .aurora-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .aurora-button.generating {
            animation: buttonPulse 2s ease-in-out infinite;
        }

        @keyframes buttonPulse {
            0%, 100% { 
                box-shadow: var(--shadow-base);
            }
            50% { 
                box-shadow: var(--shadow-base), var(--shadow-glow);
            }
        }

        /* Glass Secondary Button - New Design System */
        .glass-button {
            background: rgba(255, 255, 255, 0.06);
            backdrop-filter: var(--blur-glass);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: var(--radius-base);
            padding: 10px 16px;
            color: var(--text-primary);
            font-family: var(--font-inter);
            font-weight: var(--font-weight-medium);
            font-size: var(--font-size-ui);
            letter-spacing: var(--letter-spacing-ui);
            transition: all 0.25s ease-in-out;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
            cursor: pointer;
        }

        .glass-button:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05), 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        /* Active button states */
        .glass-button.active {
            background-color: var(--color-purple);
            color: white;
            font-weight: var(--font-weight-medium);
            box-shadow: var(--shadow-base), var(--shadow-glow);
        }

        .glass-button.active:hover {
            background-color: var(--color-purple-hover);
            transform: translateY(-1px);
        }

        /* Component Grid System */
        .component-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin: 12px 0;
        }

        .component-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-base);
            padding: 12px;
            cursor: pointer;
            transition: all 0.25s ease-in-out;
            position: relative;
        }

        .component-item:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--color-purple);
            transform: translateY(-1px);
        }

        .component-item.selected {
            background: rgba(131, 83, 218, 0.2);
            border-color: var(--color-purple);
            box-shadow: var(--shadow-glow);
        }

        .component-item .component-icon {
            width: 20px;
            height: 20px;
            margin-bottom: 8px;
            color: var(--color-purple);
        }

        .component-item .component-name {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .component-item .component-desc {
            font-size: 10px;
            color: var(--text-muted);
            line-height: 1.3;
        }

        .component-item .selection-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--color-purple);
            color: white;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }

        .component-item.selected .selection-indicator {
            display: flex;
        }

        /* Template Type Cards */
        .template-type-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 16px 0;
        }

        .template-type-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-base);
            padding: 16px;
            cursor: pointer;
            transition: all 0.25s ease-in-out;
            text-align: center;
        }

        .template-type-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--color-purple);
            transform: translateY(-2px);
        }

        .template-type-card.selected {
            background: rgba(131, 83, 218, 0.2);
            border-color: var(--color-purple);
            box-shadow: var(--shadow-glow);
        }

        .template-type-card .template-icon {
            width: 32px;
            height: 32px;
            margin: 0 auto 12px;
            color: var(--color-purple);
        }

        .template-type-card .template-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .template-type-card .template-desc {
            font-size: 11px;
            color: var(--text-muted);
            line-height: 1.4;
        }

        /* Layout Containers - New Design System */
        .sidebar {
            transition: width 0.25s ease-in-out;
            width: 25%;
            min-width: 400px;
            background: var(--color-glass-background);
            backdrop-filter: var(--blur-glass);
            border-right: 1px solid var(--color-glass-border);
            position: relative;
        }

        .sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(180deg, rgba(131, 83, 218, 0.05) 0%, rgba(149, 103, 228, 0.05) 50%, rgba(111, 65, 195, 0.05) 100%);
            pointer-events: none;
        }

        .sidebar.collapsed {
            width: 80px;
        }

        .sidebar.collapsed .sidebar-content {
            opacity: 0;
            pointer-events: none;
        }

        .sidebar-content {
            transition: opacity 0.25s ease-in-out;
            position: relative;
            z-index: 2;
        }

        .main-content {
            transition: width 0.25s ease-in-out;
            width: 75%;
            background: var(--color-black-gradient-start);
        }

        .main-content.expanded {
            width: calc(100% - 80px);
        }

        /* Template Grid - New Design System */
        .template-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
            padding: 16px;
            grid-auto-rows: minmax(300px, auto);
        }

        .template-card {
            background: var(--color-glass-background);
            backdrop-filter: var(--blur-glass);
            border: 1px solid var(--color-glass-border);
            border-radius: var(--radius-base);
            overflow: hidden;
            transition: all 0.25s ease-in-out;
            box-shadow: var(--shadow-base);
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            min-height: 300px;
            position: relative;
        }

        .template-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-base), var(--shadow-glow);
        }

        .template-card.generating {
            animation: subtleGenerate 3s ease-in-out infinite;
            border-color: var(--color-purple);
            box-shadow: var(--shadow-base), var(--shadow-glow);
        }

        @keyframes subtleGenerate {
            0%, 100% { 
                transform: translateY(0px);
                box-shadow: var(--shadow-base), var(--shadow-glow);
            }
            50% { 
                transform: translateY(-1px);
                box-shadow: var(--shadow-base), var(--shadow-glow);
            }
        }

        .template-card-header {
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            flex-shrink: 0;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .template-card .preview-frame {
            flex: 1;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            margin: 8px;
            overflow: hidden;
            min-height: 0;
        }

        .template-card .selection-checkbox {
            position: absolute;
            top: 12px;
            right: 12px;
            width: 20px;
            height: 20px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s ease-in-out;
            z-index: 10;
        }

        .template-card .selection-checkbox:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: var(--color-purple);
        }

        .template-card .selection-checkbox.selected {
            background: var(--color-purple);
            border-color: var(--color-purple);
            color: white;
        }

        /* Aurora label styling */
        .aurora-label {
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 8px;
            display: block;
        }

        /* Status text colors - New Design System */
        .status-generating { color: var(--color-purple); }
        .status-complete { color: #4ade80; }
        .status-error { color: #ef4444; }
        .status-paused { color: #fbbf24; }

        /* Empty state */
        .empty-state {
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: calc(100vh - 120px);
            text-align: center;
            padding: 48px;
            overflow: hidden;
        }

        .welcome-content {
            position: relative;
            z-index: 10;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .empty-state-icon {
            width: 120px;
            height: 120px;
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
            border: 1px solid var(--glass-border);
        }

        /* Merge Controls */
        .merge-controls {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--color-glass-background);
            backdrop-filter: var(--blur-glass);
            border: 1px solid var(--color-glass-border);
            border-radius: var(--radius-base);
            padding: 16px 24px;
            box-shadow: var(--shadow-base), var(--shadow-glow);
            display: none;
            align-items: center;
            gap: 16px;
            z-index: 50;
        }

        .merge-controls.visible {
            display: flex;
        }

        .merge-controls .selected-count {
            color: var(--color-purple);
            font-weight: 600;
            font-size: 14px;
        }

        /* Toggle button - New Design System */
        .aurora-toggle {
            background: var(--color-glass-background);
            backdrop-filter: var(--blur-glass);
            border: 1px solid var(--color-glass-border);
            border-radius: var(--radius-base);
            padding: 8px;
            color: var(--text-secondary);
            transition: all 0.25s ease-in-out;
            cursor: pointer;
        }

        .aurora-toggle:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
            transform: scale(1.05);
        }

        .aurora-toggle.rotated {
            transform: rotate(180deg) scale(1.05);
        }

        /* Scrollbar - New Design System */
        .sidebar-content::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar-content::-webkit-scrollbar-track {
            background: var(--color-glass-border);
            border-radius: 3px;
        }

        .sidebar-content::-webkit-scrollbar-thumb {
            background: #4a5568;
            border-radius: 3px;
        }

        /* 8pt grid system */
        .space-1 { margin: 8px; }
        .space-2 { margin: 16px; }
        .space-3 { margin: 24px; }
        .space-4 { margin: 32px; }
        .space-5 { margin: 40px; }
        .space-6 { margin: 48px; }

        .p-1 { padding: 8px; }
        .p-2 { padding: 16px; }
        .p-3 { padding: 24px; }
        .p-4 { padding: 32px; }

        /* Mobile responsiveness */
        @media (max-width: 1024px) {
            .sidebar { width: 35%; min-width: 350px; }
            .main-content { width: 65%; }
            .main-content.expanded { width: calc(100% - 80px); }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                min-width: 100%;
                position: fixed;
                top: 0;
                left: 0;
                height: 100vh;
                z-index: 40;
                transform: translateX(-100%);
            }
            .sidebar.open { transform: translateX(0); }
            .sidebar.collapsed { transform: translateX(-100%); }
            .main-content { width: 100%; }
            .main-content.expanded { width: 100%; }
            .mobile-overlay {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.6);
                backdrop-filter: blur(8px);
                z-index: 30;
            }
            .component-grid {
                grid-template-columns: 1fr;
            }
            .template-type-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Preset Active State - Special styling for loaded presets */
        .preset-btn.preset-active {
            background: linear-gradient(135deg, var(--color-purple), var(--color-purple-hover));
            border: 1px solid var(--color-purple-hover);
            box-shadow: var(--shadow-base), var(--shadow-glow), 0 0 20px rgba(131, 83, 218, 0.3);
            position: relative;
        }

        .preset-btn.preset-active::before {
            content: '✓';
            position: absolute;
            top: -2px;
            right: -2px;
            background: var(--color-purple-hover);
            color: white;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .preset-btn.preset-active:hover {
            background: linear-gradient(135deg, var(--color-purple-hover), var(--color-purple-active));
            transform: translateY(-2px);
            box-shadow: var(--shadow-base), var(--shadow-glow), 0 0 25px rgba(131, 83, 218, 0.4);
        }

        /* Scrollbar styling for multi-select containers */
        .multi-select-container::-webkit-scrollbar {
            width: 6px;
        }

        .multi-select-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .multi-select-container::-webkit-scrollbar-thumb {
            background: rgba(131, 83, 218, 0.4);
            border-radius: 3px;
        }

        .multi-select-container::-webkit-scrollbar-thumb:hover {
            background: rgba(131, 83, 218, 0.6);
        }

        /* Firefox scrollbar */
        .multi-select-container {
            scrollbar-width: thin;
            scrollbar-color: rgba(131, 83, 218, 0.4) rgba(255, 255, 255, 0.05);
        }

        /* ============================================
         * ENHANCED TOOLTIPS - High Z-Index
         * ============================================ */
        
        /* Custom tooltip implementation with high z-index */
        [title] {
            position: relative;
        }

        [title]:hover::before {
            content: attr(title);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #1a1a1a;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
            white-space: nowrap;
            z-index: 99999;
            opacity: 0;
            animation: tooltipFadeIn 0.2s ease-out forwards;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(8px);
            margin-bottom: 8px;
            pointer-events: none;
        }

        [title]:hover::after {
            content: '';
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            border-width: 4px;
            border-style: solid;
            border-color: #1a1a1a transparent transparent transparent;
            z-index: 99999;
            margin-bottom: 4px;
            pointer-events: none;
        }

        @keyframes tooltipFadeIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(4px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* Disable default browser tooltips */
        [title] {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* ============================================
         * LOADING STATES & ANIMATIONS
         * ============================================ */

        /* Loading button states */
        .button-loading {
            position: relative;
            pointer-events: none;
            opacity: 0.7;
        }

        .button-loading::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            z-index: 10;
        }

        .button-loading * {
            opacity: 0;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Template card loading state */
        .template-card-loading {
            position: relative;
            overflow: hidden;
        }

        .template-card-loading::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(
                90deg,
                transparent,
                rgba(131, 83, 218, 0.1),
                transparent
            );
            animation: shimmer 2s infinite;
            z-index: 1;
        }

        .template-card-loading .template-card-header {
            position: relative;
            z-index: 2;
        }

        @keyframes shimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        /* Progress indicators */
        .progress-pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        /* Generation status indicators */
        .status-generating {
            color: #fbbf24;
        }

        .status-complete {
            color: #10b981;
        }

        .status-error {
            color: #ef4444;
        }

        /* Enhanced loading dots */
        .loading-dots {
            display: inline-flex;
            align-items: center;
            gap: 2px;
        }

        .loading-dots span {
            width: 4px;
            height: 4px;
            background: currentColor;
            border-radius: 50%;
            animation: loadingDots 1.4s infinite ease-in-out;
        }

        .loading-dots span:nth-child(1) { animation-delay: 0s; }
        .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
        .loading-dots span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes loadingDots {
            0%, 60%, 100% {
                transform: scale(1);
                opacity: 0.6;
            }
            30% {
                transform: scale(1.2);
                opacity: 1;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans antialiased overflow-hidden">
    <!-- Main Layout Container -->
    <div class="flex h-screen">
        <!-- Mobile Overlay -->
        <div id="mobileOverlay" class="mobile-overlay hidden lg:hidden"></div>
        
        <!-- Left Sidebar (25% width) -->
        <div id="sidebar" class="sidebar flex flex-col overflow-hidden">
            <!-- Sidebar Header -->
            <div class="flex-shrink-0 p-3 border-b border-white border-opacity-20 flex justify-between items-center">
                <div class="sidebar-content">
                    <h1 class="heading-sm text-white">Template Builder</h1>
                    <p class="text-sm text-white text-opacity-70 mt-1">AI-powered template generator</p>
                </div>
                <button id="apiSettingsBtn" class="aurora-toggle rounded-lg transition-colors">
                    <i data-lucide="settings" class="w-5 h-5 aurora-icon"></i>
                </button>
            </div>
            
            <!-- Sidebar Content -->
            <div class="sidebar-content flex-1 overflow-y-auto p-3">
                <!-- Configuration Management -->
                <div class="glass-card p-3 mb-4">
                    <div class="flex items-center justify-between mb-3">
                        <label class="aurora-label text-sm mb-0">Configuration</label>
                        <div class="flex items-center gap-1">
                            <span id="autoSaveStatus" class="text-xs text-green-400 opacity-75">Auto-saved</span>
                            <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                        </div>
                    </div>
                    
                    <!-- Smart Presets -->
                    <div class="mb-3">
                        <div class="text-xs font-medium text-white text-opacity-70 mb-2">Quick Presets</div>
                        <div class="grid grid-cols-2 gap-1">
                            <button class="preset-btn glass-button py-1.5 px-2 rounded text-xs font-medium transition-all" data-preset="saas-startup">
                                <i data-lucide="zap" class="w-3 h-3 inline mr-1"></i>
                                SaaS Startup
                            </button>
                            <button class="preset-btn glass-button py-1.5 px-2 rounded text-xs font-medium transition-all" data-preset="ecommerce-store">
                                <i data-lucide="shopping-cart" class="w-3 h-3 inline mr-1"></i>
                                E-commerce
                            </button>
                            <button class="preset-btn glass-button py-1.5 px-2 rounded text-xs font-medium transition-all" data-preset="portfolio-creative">
                                <i data-lucide="palette" class="w-3 h-3 inline mr-1"></i>
                                Portfolio
                            </button>
                            <button class="preset-btn glass-button py-1.5 px-2 rounded text-xs font-medium transition-all" data-preset="corporate-business">
                                <i data-lucide="building" class="w-3 h-3 inline mr-1"></i>
                                Corporate
                            </button>
                        </div>
                    </div>
                    
                    <!-- Configuration Controls -->
                    <div class="grid grid-cols-3 gap-1">
                        <button id="saveConfigBtn" class="glass-button py-1.5 px-2 rounded text-xs font-medium transition-all" title="Save current configuration">
                            <i data-lucide="save" class="w-3 h-3 inline mr-1"></i>
                            Save
                        </button>
                        <button id="exportConfigBtn" class="glass-button py-1.5 px-2 rounded text-xs font-medium transition-all" title="Export configuration as file">
                            <i data-lucide="download" class="w-3 h-3 inline mr-1"></i>
                            Export
                        </button>
                        <button id="importConfigBtn" class="glass-button py-1.5 px-2 rounded text-xs font-medium transition-all" title="Import configuration from file">
                            <i data-lucide="upload" class="w-3 h-3 inline mr-1"></i>
                            Import
                        </button>
                    </div>
                    <input type="file" id="configFile" class="hidden" accept=".json">
                </div>

                <!-- Template Builder Form -->
                <div class="space-y-4 fade-up">
                    
                    <!-- Step 1: Input Method -->
                    <div class="glass-card p-4">
                        <div class="flex items-center gap-2 mb-2">
                            <label class="aurora-label mb-0">1. Input Method</label>
                            <div class="relative group">
                                <i data-lucide="help-circle" class="w-4 h-4 text-white text-opacity-40 cursor-help"></i>
                                <div class="absolute bottom-full left-0 mb-2 px-3 py-2 bg-black bg-opacity-90 text-white text-xs rounded-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 whitespace-nowrap z-10">
                                    Choose how you want to provide your template requirements
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 mt-2">
                            <button class="input-method-btn glass-button py-2 px-3 rounded-lg text-sm font-medium transition-all active flex items-center justify-center gap-2 relative group" data-value="prompt" title="Describe your template with text or paste code">
                                <i data-lucide="type" class="w-4 h-4"></i>
                                <span class="text-sm">Text</span>
                            </button>
                            <button class="input-method-btn glass-button py-2 px-3 rounded-lg text-sm font-medium transition-all flex items-center justify-center gap-2 relative group" data-value="reference" title="Upload HTML, CSS files or folders as reference">
                                <i data-lucide="upload" class="w-4 h-4"></i>
                                <span class="text-sm">Upload</span>
                            </button>
                        </div>
                        
                        <!-- Prompt Input -->
                        <div id="promptInput" class="mt-4">
                            <div class="flex items-center justify-between mb-2">
                                <span class="text-xs font-medium text-white text-opacity-70">Template Description</span>
                                <span id="promptCharCount" class="text-xs text-white text-opacity-50">0 characters</span>
                            </div>
                            <textarea id="mainPrompt" rows="9" class="aurora-input w-full rounded-lg transition" placeholder="Describe your template or paste HTML/CSS/Design code directly...&#10;&#10;Text Example: 'Modern SaaS landing page with pricing tiers and testimonials'&#10;&#10;Code Example: Paste your HTML, CSS, or design system code for reference"></textarea>
                        </div>

                        <!-- Reference Upload -->
                        <div id="referenceInput" class="mt-4 hidden">
                            <!-- Unified File upload area -->
                            <div id="fileUploadArea" class="border-2 border-dashed border-white border-opacity-20 rounded-lg p-6 text-center cursor-pointer hover:border-opacity-40 transition-all">
                                <i data-lucide="upload-cloud" class="w-12 h-12 text-white text-opacity-40 mx-auto mb-3"></i>
                                <h4 class="text-sm font-medium text-white text-opacity-80 mb-2">Upload Reference Files</h4>
                                <p class="text-xs text-white text-opacity-60 mb-3">
                                    Drag & drop or click to upload HTML files, CSS files, or entire folders
                                </p>
                                <div class="flex items-center justify-center gap-4 text-xs text-white text-opacity-50">
                                    <span class="flex items-center gap-1">
                                        <i data-lucide="code" class="w-3 h-3"></i>
                                        HTML
                                    </span>
                                    <span class="flex items-center gap-1">
                                        <i data-lucide="paintbrush" class="w-3 h-3"></i>
                                        CSS
                                    </span>
                                    <span class="flex items-center gap-1">
                                        <i data-lucide="folder" class="w-3 h-3"></i>
                                        Folders
                                    </span>
                                </div>
                                <input type="file" id="referenceFile" class="hidden" multiple accept=".html,.htm,.css,.js,.json,.txt">
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Template Type -->
                    <div class="glass-card p-4">
                        <div class="flex items-center gap-2 mb-2">
                            <label for="templateTypeSelect" class="aurora-label mb-0">2. Template Type</label>
                            <div class="relative group">
                                <i data-lucide="help-circle" class="w-4 h-4 text-white text-opacity-40 cursor-help"></i>
                                <div class="absolute bottom-full left-0 mb-2 px-3 py-2 bg-black bg-opacity-90 text-white text-xs rounded-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 whitespace-nowrap z-10">
                                    Select the type of template you want to create
                                </div>
                            </div>
                        </div>
                        <select id="templateTypeSelect" class="aurora-select w-full rounded-lg transition" title="Choose the primary purpose of your template">
                            <option value="">Select a template type...</option>
                            <option value="landing">🏠 Landing Page - Single page websites with hero, features, and CTA</option>
                            <option value="website">🌐 Full Website - Multi-page sites with navigation and content pages</option>
                            <option value="webapp">💻 Web App - Interactive applications with user interfaces</option>
                            <option value="mobile">📱 Mobile App - Mobile-first responsive designs</option>
                            <option value="saas">⚡ SaaS Product - Software as a Service platforms</option>
                            <option value="dashboard">📊 Dashboard - Admin panels and data visualization</option>
                            <option value="ecommerce">🛒 E-commerce - Online stores and product catalogs</option>
                            <option value="social">📱 Social Post - Social media posts and content</option>
                            <option value="pdf">📄 PDF Report - Professional reports and documents</option>
                            <option value="ppt">🎤 Presentation - PowerPoint and slide presentations</option>
                        </select>
                    </div>

                    <!-- Step 3: Components Selection -->
                    <div class="glass-card p-4">
                        <label class="aurora-label">3. Select Components</label>
                        <div id="componentSelection" class="space-y-4">
                            
                            <!-- Sections Multi-Select -->
                            <div>
                                <label class="text-xs font-medium text-white text-opacity-70 mb-2 block">Sections</label>
                                <div id="sectionsContainer" class="multi-select-container">
                                    <div class="text-center text-white text-opacity-50 py-4">
                                        <p class="text-sm">Select a template type first...</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Components Multi-Select -->
                            <div>
                                <label class="text-xs font-medium text-white text-opacity-70 mb-2 block">Components</label>
                                <div id="componentsContainer" class="multi-select-container">
                                    <div class="text-center text-white text-opacity-50 py-4">
                                        <p class="text-sm">Select a template type first...</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Pages Multi-Select -->
                            <div>
                                <label class="text-xs font-medium text-white text-opacity-70 mb-2 block">Pages</label>
                                <div id="pagesContainer" class="multi-select-container">
                                    <div class="text-center text-white text-opacity-50 py-4">
                                        <p class="text-sm">Select a template type first...</p>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <!-- Step 4: Custom Generation -->
                    <div class="glass-card p-4">
                        <label class="aurora-label">4. Custom Generation</label>
                        <p class="text-xs text-white text-opacity-60 mb-3">
                            Specify any additional components, sections, or custom requirements not covered in the lists above
                        </p>
                        
                        <textarea 
                            id="customGeneration" 
                            rows="4" 
                            class="aurora-input w-full rounded-lg transition" 
                            placeholder="Example: 'Add a testimonial carousel with video backgrounds', 'Include a live chat widget', 'Add custom animations on scroll', etc.">
                        </textarea>
                        
                        <p class="text-xs text-white text-opacity-50 mt-2">
                            💡 This will be combined with your selected components to create a comprehensive template
                        </p>
                    </div>

                    <!-- Step 5: Generation Options -->
                    <div class="glass-card p-4">
                        <div class="flex items-center gap-2 mb-3">
                            <label class="aurora-label mb-0">5. Generation Options</label>
                            <div class="relative group">
                                <i data-lucide="help-circle" class="w-4 h-4 text-white text-opacity-40 cursor-help"></i>
                                <div class="absolute bottom-full left-0 mb-2 px-3 py-2 bg-black bg-opacity-90 text-white text-xs rounded-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 whitespace-nowrap z-10">
                                    Configure how many variations to generate
                                </div>
                            </div>
                        </div>
                        
                        <!-- Number of Variations -->
                        <div class="mb-4">
                            <div class="flex items-center justify-between mb-2">
                                <div class="text-xs font-medium text-white text-opacity-70">Variations per Component</div>
                                <span class="text-xs text-white text-opacity-50">More = Better options</span>
                            </div>
                            <div class="grid grid-cols-4 gap-2">
                                <button class="variation-btn glass-button py-2 px-3 rounded-lg text-sm font-medium transition-all active" data-value="2" title="Quick generation">2</button>
                                <button class="variation-btn glass-button py-2 px-3 rounded-lg text-sm font-medium transition-all" data-value="3" title="Balanced options">3</button>
                                <button class="variation-btn glass-button py-2 px-3 rounded-lg text-sm font-medium transition-all" data-value="5" title="Good variety">5</button>
                                <button class="variation-btn glass-button py-2 px-3 rounded-lg text-sm font-medium transition-all" data-value="10" title="Maximum options">10</button>
                            </div>
                        </div>

                        <!-- Advanced Options (Collapsible) -->
                        <div class="border-t border-white border-opacity-10 pt-3">
                            <button id="advancedToggle" class="flex items-center justify-between w-full text-xs font-medium text-white text-opacity-70 hover:text-white transition-colors">
                                <span class="flex items-center gap-2">
                                    <i data-lucide="settings" class="w-3 h-3"></i>
                                    Advanced Options
                                </span>
                                <i data-lucide="chevron-down" class="w-3 h-3 transition-transform duration-200"></i>
                            </button>
                            
                            <div id="advancedOptions" class="hidden mt-3 space-y-3">
                                <!-- Output Format -->
                                <div>
                                    <div class="text-xs font-medium text-white text-opacity-70 mb-2">Output Format</div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <button class="format-btn glass-button py-1.5 px-3 rounded text-xs font-medium transition-all active" data-value="html">
                                            <i data-lucide="code" class="w-3 h-3 inline mr-1"></i>
                                            HTML
                                        </button>
                                        <button class="format-btn glass-button py-1.5 px-3 rounded text-xs font-medium transition-all" data-value="react">
                                            <i data-lucide="layers" class="w-3 h-3 inline mr-1"></i>
                                            React
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- CSS Framework -->
                                <div>
                                    <div class="text-xs font-medium text-white text-opacity-70 mb-2">CSS Framework</div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <button class="framework-btn glass-button py-1.5 px-3 rounded text-xs font-medium transition-all active" data-value="tailwind">
                                            <i data-lucide="wind" class="w-3 h-3 inline mr-1"></i>
                                            Tailwind
                                        </button>
                                        <button class="framework-btn glass-button py-1.5 px-3 rounded text-xs font-medium transition-all" data-value="bootstrap">
                                            <i data-lucide="grid-3x3" class="w-3 h-3 inline mr-1"></i>
                                            Bootstrap
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Quality Level -->
                                <div>
                                    <div class="text-xs font-medium text-white text-opacity-70 mb-2">Quality Level</div>
                                    <div class="grid grid-cols-3 gap-1">
                                        <button class="quality-btn glass-button py-1.5 px-2 rounded text-xs font-medium transition-all" data-value="fast">Fast</button>
                                        <button class="quality-btn glass-button py-1.5 px-2 rounded text-xs font-medium transition-all active" data-value="balanced">Balanced</button>
                                        <button class="quality-btn glass-button py-1.5 px-2 rounded text-xs font-medium transition-all" data-value="premium">Premium</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Generate Button -->
                    <div class="pt-2">
                        <button id="generateBtn" class="aurora-button w-full py-4 px-6 rounded-lg shadow-lg transition flex items-center justify-center gap-3">
                            <i data-lucide="sparkles" class="w-5 h-5"></i>
                            <span class="font-semibold">Generate Templates</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Main Content (75% width) -->
        <div id="mainContent" class="main-content flex flex-col overflow-hidden">
            <!-- Top Progress Bar -->
            <div id="topProgressBar" class="hidden">
                <div class="top-progress-fill"></div>
            </div>
            
            <!-- Header Bar -->
            <div class="flex-shrink-0 px-6 py-4" style="background: var(--color-glass-background); backdrop-filter: var(--blur-glass); border-bottom: 1px solid var(--color-glass-border);">
                <div class="flex justify-between items-center">
                    <!-- Mobile Menu Button -->
                    <button id="mobileMenuBtn" class="lg:hidden aurora-toggle p-2 rounded-lg">
                        <i data-lucide="menu" class="w-5 h-5 aurora-icon"></i>
                    </button>
                    
                    <div class="flex items-center space-x-4">
                        <!-- Progress Tracker -->
                        <div id="headerProgressContainer" class="hidden">
                            <div class="flex items-center space-x-4">
                                <div class="flex items-center space-x-2">
                                    <span class="text-sm text-white text-opacity-80">
                                        <span id="headerCompletedCount" class="font-medium mono" style="color: var(--aurora-cyan)">0</span>/<span id="headerTotalCount" class="font-medium mono" style="color: var(--aurora-cyan)">0</span>
                                    </span>
                                    <span id="headerStatusText" class="text-sm font-medium status-generating">Ready</span>
                                </div>
                                <div class="flex gap-2">
                                    <button id="headerPauseBtn" class="glass-button p-2 rounded transition-colors" title="Pause">
                                        <i data-lucide="pause" class="w-4 h-4 aurora-icon"></i>
                                    </button>
                                    <button id="headerResumeBtn" class="glass-button p-2 rounded transition-colors hidden" title="Resume">
                                        <i data-lucide="play" class="w-4 h-4 aurora-icon"></i>
                                    </button>
                                    <button id="headerStopBtn" class="glass-button p-2 rounded transition-colors hover:bg-red-500 hover:bg-opacity-20" title="Stop">
                                        <i data-lucide="square" class="w-4 h-4 aurora-icon"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="resultsContainer" class="hidden">
                            <div class="flex items-center gap-3">
                                <button id="selectAllBtn" class="glass-button flex items-center gap-2 py-2 px-4 rounded-lg">
                                    <i data-lucide="check-square" class="w-4 h-4"></i>
                                    <span class="font-medium">Select All</span>
                                </button>
                                <button id="downloadAllBtn" class="aurora-button flex items-center gap-2 py-2 px-4 rounded-lg">
                                    <i data-lucide="download" class="w-4 h-4"></i>
                                    <span class="font-medium">Download Selected</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Templates Grid Area -->
            <div class="flex-1 overflow-y-auto">
                <div id="templatesGrid" class="template-grid"></div>
                
                <!-- Empty State -->
                <div id="emptyState" class="empty-state">
                    <div class="welcome-content">
                        <div class="empty-state-icon">
                            <i data-lucide="layout-template" class="w-20 h-20" style="color: var(--aurora-cyan)"></i>
                        </div>
                        
                        <h1 class="text-4xl md:text-5xl mb-6 text-center font-bold leading-tight" style="background: linear-gradient(135deg, var(--color-purple), var(--color-purple-hover)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">
                            AI-Powered Template Builder
                        </h1>
                        
                        <div class="max-w-4xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6 mb-8">
                            <div class="flex items-center gap-4 text-white text-opacity-90 text-lg">
                                <i data-lucide="puzzle" class="w-6 h-6 flex-shrink-0" style="color: var(--aurora-cyan)"></i>
                                <span class="font-medium">Modular Component System</span>
                            </div>
                            <div class="flex items-center gap-4 text-white text-opacity-90 text-lg">
                                <i data-lucide="layers" class="w-6 h-6 flex-shrink-0" style="color: var(--aurora-cyan)"></i>
                                <span class="font-medium">Multiple Design Variations</span>
                            </div>
                            <div class="flex items-center gap-4 text-white text-opacity-90 text-lg">
                                <i data-lucide="merge" class="w-6 h-6 flex-shrink-0" style="color: var(--aurora-cyan)"></i>
                                <span class="font-medium">Merge & Combine Templates</span>
                            </div>
                            <div class="flex items-center gap-4 text-white text-opacity-90 text-lg">
                                <i data-lucide="download" class="w-6 h-6 flex-shrink-0" style="color: var(--aurora-cyan)"></i>
                                <span class="font-medium">Export Ready-to-Use Code</span>
                            </div>
                            <div class="flex items-center gap-4 text-white text-opacity-90 text-lg">
                                <i data-lucide="upload" class="w-6 h-6 flex-shrink-0" style="color: var(--aurora-cyan)"></i>
                                <span class="font-medium">Upload Design References</span>
                            </div>
                            <div class="flex items-center gap-4 text-white text-opacity-90 text-lg">
                                <i data-lucide="zap" class="w-6 h-6 flex-shrink-0" style="color: var(--aurora-cyan)"></i>
                                <span class="font-medium">AI-Enhanced Generation</span>
                            </div>
                        </div>
                        
                        <p class="text-xl text-center mb-8 text-white text-opacity-80 font-medium leading-relaxed">
                            Build complex applications with modular templates, UI components, and design systems.
                        </p>
                        
                        <div class="text-center">
                            <button onclick="document.getElementById('mainPrompt').focus()" class="aurora-button py-5 px-10 text-xl font-bold rounded-2xl shadow-2xl flex items-center gap-4 mx-auto relative z-10">
                                <i data-lucide="play" class="w-7 h-7"></i>
                                <span>Start Building Templates</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Merge Controls (Fixed Bottom) -->
    <div id="mergeControls" class="merge-controls">
        <span class="selected-count">3 components selected</span>
        <button id="mergeBtn" class="aurora-button py-2 px-4 rounded-lg flex items-center gap-2">
            <i data-lucide="merge" class="w-4 h-4"></i>
            <span>Merge Selected</span>
        </button>
        <button id="clearSelectionBtn" class="glass-button py-2 px-4 rounded-lg">
            Clear Selection
        </button>
    </div>

    <!-- API Settings Modal -->
    <div id="apiSettingsModal" class="fixed inset-0 flex items-center justify-center hidden z-50 p-4" style="background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px);">
        <div class="glass-card w-full max-w-md max-h-[90vh] overflow-y-auto">
            <div class="px-6 py-4 border-b border-white border-opacity-20 flex justify-between items-center sticky top-0 bg-inherit">
                <h3 class="heading-sm text-white">API Settings</h3>
                <button id="closeModalBtn" class="aurora-toggle p-2 rounded transition-colors">
                    <i data-lucide="x" class="w-5 h-5 aurora-icon"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <!-- API Key Input -->
                <div>
                    <label for="apiKey" class="aurora-label">OpenRouter API Key</label>
                    <div class="relative">
                        <input id="apiKey" type="password" class="aurora-input w-full pr-12">
                        <button id="toggleApiKeyVisibility" class="absolute inset-y-0 right-0 pr-3 flex items-center">
                            <i data-lucide="eye" class="w-5 h-5 text-white text-opacity-60 hover:text-white transition-colors aurora-icon"></i>
                        </button>
                    </div>
                    <p class="mt-2 text-sm text-white text-opacity-60">Get your API key from <a href="https://openrouter.ai/" target="_blank" class="hover:underline" style="color: var(--aurora-cyan)">OpenRouter</a></p>
                </div>

                <!-- Model Selection -->
                <div>
                    <label for="modalAiModel" class="aurora-label">AI Model</label>
                    <select id="modalAiModel" class="aurora-select w-full">
                        <option value="deepseek/deepseek-chat-v3-0324:free" selected>DeepSeek Chat V3 (Free)</option>
                        <option value="google/gemini-2.0-flash-exp:free">Gemini 2.0 Flash (Free)</option>
                        <option value="qwen/qwen-2.5-72b-instruct:free">Qwen 2.5 72B (Free)</option>
                    </select>
                </div>

                <!-- Save Button -->
                <div class="pt-4">
                    <button id="saveSettingsBtn" class="aurora-button w-full py-3 px-6 rounded-lg flex items-center justify-center gap-3">
                        <i data-lucide="save" class="w-5 h-5"></i>
                        <span class="font-semibold">Save Settings</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // DOM Elements
        const apiSettingsBtn = document.getElementById('apiSettingsBtn');
        const apiSettingsModal = document.getElementById('apiSettingsModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const generateBtn = document.getElementById('generateBtn');
        const templatesGrid = document.getElementById('templatesGrid');
        const emptyState = document.getElementById('emptyState');
        const resultsContainer = document.getElementById('resultsContainer');
        const headerProgressContainer = document.getElementById('headerProgressContainer');
        const mergeControls = document.getElementById('mergeControls');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const mobileOverlay = document.getElementById('mobileOverlay');

        // State variables
        let selectedComponents = new Set();
        let selectedTemplateType = '';
        let inputMethod = 'prompt';
        let referenceType = 'html';
        let generatedTemplates = [];
        let selectedTemplates = new Set();
        let isGenerating = false;

        // Comprehensive Template-Specific Component Mappings
        const TEMPLATE_COMPONENTS = {
            'landing': {
                sections: [
                    { value: 'hero', icon: 'layout', name: 'Hero Banner', desc: 'Main banner with headline and CTA' },
                    { value: 'features', icon: 'star', name: 'Features', desc: 'Product highlights and benefits' },
                    { value: 'benefits', icon: 'check-circle', name: 'Benefits', desc: 'Why choose us section' },
                    { value: 'pricing', icon: 'credit-card', name: 'Pricing', desc: 'Plans and pricing tables' },
                    { value: 'testimonials', icon: 'quote', name: 'Testimonials', desc: 'Customer reviews and quotes' },
                    { value: 'faq', icon: 'help-circle', name: 'FAQ', desc: 'Frequently asked questions' },
                    { value: 'cta', icon: 'zap', name: 'Call to Action', desc: 'Final conversion section' },
                    { value: 'newsletter', icon: 'mail', name: 'Newsletter', desc: 'Email signup section' },
                    { value: 'about', icon: 'info', name: 'About Us', desc: 'Company introduction' },
                    { value: 'process', icon: 'arrow-right', name: 'Process', desc: 'How it works steps' },
                    { value: 'gallery', icon: 'image', name: 'Gallery', desc: 'Image showcase' },
                    { value: 'footer', icon: 'layout', name: 'Footer', desc: 'Site footer with links' }
                ],
                components: [
                    { value: 'navbar', icon: 'menu', name: 'Navigation', desc: 'Header navigation menu' },
                    { value: 'buttons', icon: 'mouse-pointer-click', name: 'CTA Buttons', desc: 'Call-to-action buttons' },
                    { value: 'forms', icon: 'clipboard-list', name: 'Lead Forms', desc: 'Contact and signup forms' },
                    { value: 'icons', icon: 'star', name: 'Feature Icons', desc: 'Icons for features' },
                    { value: 'badges', icon: 'award', name: 'Trust Badges', desc: 'Security and trust indicators' },
                    { value: 'counters', icon: 'trending-up', name: 'Stats Counters', desc: 'Animated number counters' },
                    { value: 'progress', icon: 'bar-chart', name: 'Progress Bars', desc: 'Visual progress indicators' }
                ],
                pages: [
                    { value: 'homepage', icon: 'home', name: 'Landing Page', desc: 'Main landing page' },
                    { value: 'thankyou', icon: 'check', name: 'Thank You', desc: 'Post-conversion page' },
                    { value: 'privacy', icon: 'shield', name: 'Privacy Policy', desc: 'Privacy policy page' },
                    { value: 'terms', icon: 'file-text', name: 'Terms of Service', desc: 'Terms and conditions' }
                ]
            },

            'website': {
                sections: [
                    { value: 'hero', icon: 'layout', name: 'Hero Section', desc: 'Main banner with company intro' },
                    { value: 'about', icon: 'info', name: 'About Section', desc: 'Company overview' },
                    { value: 'services', icon: 'briefcase', name: 'Services', desc: 'What we offer' },
                    { value: 'portfolio', icon: 'folder', name: 'Portfolio', desc: 'Work showcase' },
                    { value: 'team', icon: 'users', name: 'Team', desc: 'Meet the team section' },
                    { value: 'testimonials', icon: 'quote', name: 'Testimonials', desc: 'Client feedback' },
                    { value: 'blog', icon: 'book-open', name: 'Blog Preview', desc: 'Latest articles' },
                    { value: 'contact', icon: 'mail', name: 'Contact', desc: 'Contact information' },
                    { value: 'footer', icon: 'layout', name: 'Footer', desc: 'Site footer' }
                ],
                components: [
                    { value: 'navbar', icon: 'menu', name: 'Navigation', desc: 'Main site navigation' },
                    { value: 'breadcrumbs', icon: 'chevron-right', name: 'Breadcrumbs', desc: 'Navigation trail' },
                    { value: 'search', icon: 'search', name: 'Search', desc: 'Site search functionality' },
                    { value: 'social', icon: 'share-2', name: 'Social Links', desc: 'Social media buttons' },
                    { value: 'comments', icon: 'message-circle', name: 'Comments', desc: 'Comment system' },
                    { value: 'pagination', icon: 'more-horizontal', name: 'Pagination', desc: 'Page navigation' }
                ],
                pages: [
                    { value: 'homepage', icon: 'home', name: 'Homepage', desc: 'Main website page' },
                    { value: 'about', icon: 'info', name: 'About Us', desc: 'About page' },
                    { value: 'services', icon: 'briefcase', name: 'Services', desc: 'Services listing' },
                    { value: 'portfolio', icon: 'folder', name: 'Portfolio', desc: 'Work portfolio' },
                    { value: 'blog', icon: 'book-open', name: 'Blog', desc: 'Blog listing page' },
                    { value: 'contact', icon: 'phone', name: 'Contact', desc: 'Contact page' },
                    { value: 'privacy', icon: 'shield', name: 'Privacy', desc: 'Privacy policy' },
                    { value: 'terms', icon: 'file-text', name: 'Terms', desc: 'Terms of service' }
                ]
            },

            'webapp': {
                sections: [
                    { value: 'dashboard', icon: 'layout-dashboard', name: 'Dashboard', desc: 'Main app dashboard' },
                    { value: 'sidebar', icon: 'sidebar', name: 'Sidebar', desc: 'Navigation sidebar' },
                    { value: 'header', icon: 'layout', name: 'App Header', desc: 'Top application bar' },
                    { value: 'content', icon: 'square', name: 'Main Content', desc: 'Primary content area' },
                    { value: 'settings', icon: 'settings', name: 'Settings', desc: 'User preferences' },
                    { value: 'profile', icon: 'user', name: 'Profile', desc: 'User profile section' }
                ],
                components: [
                    { value: 'navbar', icon: 'menu', name: 'App Navigation', desc: 'Application navigation' },
                    { value: 'tables', icon: 'table', name: 'Data Tables', desc: 'Sortable data tables' },
                    { value: 'charts', icon: 'bar-chart-3', name: 'Charts', desc: 'Data visualization' },
                    { value: 'forms', icon: 'clipboard-list', name: 'Input Forms', desc: 'Data entry forms' },
                    { value: 'modals', icon: 'square', name: 'Modal Dialogs', desc: 'Popup windows' },
                    { value: 'notifications', icon: 'bell', name: 'Notifications', desc: 'Alert system' },
                    { value: 'tabs', icon: 'folder', name: 'Tab Navigation', desc: 'Tabbed interface' },
                    { value: 'dropdowns', icon: 'chevron-down', name: 'Dropdowns', desc: 'Dropdown menus' }
                ],
                pages: [
                    { value: 'dashboard', icon: 'layout-dashboard', name: 'Dashboard', desc: 'Main dashboard page' },
                    { value: 'profile', icon: 'user', name: 'User Profile', desc: 'Profile management' },
                    { value: 'settings', icon: 'settings', name: 'Settings', desc: 'App preferences' },
                    { value: 'reports', icon: 'file-text', name: 'Reports', desc: 'Data reports' },
                    { value: 'users', icon: 'users', name: 'User Management', desc: 'User administration' },
                    { value: 'analytics', icon: 'trending-up', name: 'Analytics', desc: 'Usage analytics' }
                ]
            },

            'mobile': {
                sections: [
                    { value: 'header', icon: 'smartphone', name: 'Mobile Header', desc: 'Top status bar area' },
                    { value: 'navigation', icon: 'menu', name: 'Bottom Navigation', desc: 'Bottom tab bar' },
                    { value: 'content', icon: 'square', name: 'Content Area', desc: 'Main scrollable content' },
                    { value: 'drawer', icon: 'sidebar', name: 'Drawer Menu', desc: 'Side navigation menu' },
                    { value: 'statusbar', icon: 'battery', name: 'Status Bar', desc: 'System status indicators' }
                ],
                components: [
                    { value: 'buttons', icon: 'mouse-pointer-click', name: 'Touch Buttons', desc: 'Mobile-optimized buttons' },
                    { value: 'cards', icon: 'square', name: 'Mobile Cards', desc: 'Content cards for mobile' },
                    { value: 'lists', icon: 'list', name: 'List Views', desc: 'Scrollable list components' },
                    { value: 'switches', icon: 'toggle-left', name: 'Toggle Switches', desc: 'On/off controls' },
                    { value: 'sliders', icon: 'sliders', name: 'Range Sliders', desc: 'Value selection sliders' },
                    { value: 'sheets', icon: 'sheet', name: 'Bottom Sheets', desc: 'Modal bottom panels' },
                    { value: 'fab', icon: 'plus-circle', name: 'Floating Action', desc: 'Floating action button' }
                ],
                pages: [
                    { value: 'home', icon: 'home', name: 'Home Screen', desc: 'Main app screen' },
                    { value: 'profile', icon: 'user', name: 'Profile', desc: 'User profile screen' },
                    { value: 'settings', icon: 'settings', name: 'Settings', desc: 'App settings screen' },
                    { value: 'search', icon: 'search', name: 'Search', desc: 'Search interface' },
                    { value: 'notifications', icon: 'bell', name: 'Notifications', desc: 'Notification center' }
                ]
            },

            'saas': {
                sections: [
                    { value: 'hero', icon: 'zap', name: 'SaaS Hero', desc: 'Product hero with demo' },
                    { value: 'features', icon: 'star', name: 'Key Features', desc: 'Product capabilities' },
                    { value: 'pricing', icon: 'credit-card', name: 'Pricing Plans', desc: 'Subscription tiers' },
                    { value: 'testimonials', icon: 'quote', name: 'Customer Stories', desc: 'Success stories' },
                    { value: 'demo', icon: 'play-circle', name: 'Product Demo', desc: 'Interactive demo' },
                    { value: 'integrations', icon: 'link', name: 'Integrations', desc: 'Third-party connections' },
                    { value: 'security', icon: 'shield', name: 'Security', desc: 'Security features' },
                    { value: 'api', icon: 'code', name: 'API Access', desc: 'Developer resources' }
                ],
                components: [
                    { value: 'pricing-cards', icon: 'credit-card', name: 'Pricing Cards', desc: 'Plan comparison cards' },
                    { value: 'feature-lists', icon: 'check-circle', name: 'Feature Lists', desc: 'Feature comparison tables' },
                    { value: 'integration-cards', icon: 'link', name: 'Integration Cards', desc: 'Partner integration tiles' },
                    { value: 'security-badges', icon: 'shield', name: 'Security Badges', desc: 'Compliance indicators' },
                    { value: 'demo-videos', icon: 'play', name: 'Demo Videos', desc: 'Product demonstration videos' }
                ],
                pages: [
                    { value: 'homepage', icon: 'home', name: 'Product Home', desc: 'SaaS homepage' },
                    { value: 'pricing', icon: 'credit-card', name: 'Pricing', desc: 'Pricing page' },
                    { value: 'features', icon: 'star', name: 'Features', desc: 'Features overview' },
                    { value: 'about', icon: 'info', name: 'About', desc: 'Company information' },
                    { value: 'contact', icon: 'phone', name: 'Contact Sales', desc: 'Sales contact' },
                    { value: 'login', icon: 'log-in', name: 'Login', desc: 'User login page' },
                    { value: 'signup', icon: 'user-plus', name: 'Sign Up', desc: 'User registration' },
                    { value: 'dashboard', icon: 'layout-dashboard', name: 'App Dashboard', desc: 'User dashboard' }
                ]
            },

            'dashboard': {
                sections: [
                    { value: 'sidebar', icon: 'sidebar', name: 'Navigation Sidebar', desc: 'Main navigation panel' },
                    { value: 'header', icon: 'layout', name: 'Dashboard Header', desc: 'Top navigation bar' },
                    { value: 'widgets', icon: 'grid-3x3', name: 'Dashboard Widgets', desc: 'Key metric widgets' },
                    { value: 'charts', icon: 'bar-chart-3', name: 'Analytics Charts', desc: 'Data visualization' },
                    { value: 'tables', icon: 'table', name: 'Data Tables', desc: 'Detailed data tables' }
                ],
                components: [
                    { value: 'kpi-cards', icon: 'trending-up', name: 'KPI Cards', desc: 'Key performance indicators' },
                    { value: 'charts', icon: 'pie-chart', name: 'Chart Components', desc: 'Various chart types' },
                    { value: 'tables', icon: 'table', name: 'Data Tables', desc: 'Sortable data tables' },
                    { value: 'filters', icon: 'filter', name: 'Data Filters', desc: 'Data filtering controls' },
                    { value: 'search', icon: 'search', name: 'Search Bar', desc: 'Data search functionality' },
                    { value: 'export', icon: 'download', name: 'Export Tools', desc: 'Data export options' },
                    { value: 'navigation', icon: 'menu', name: 'Dashboard Nav', desc: 'Dashboard navigation' }
                ],
                pages: [
                    { value: 'overview', icon: 'layout-dashboard', name: 'Overview', desc: 'Main dashboard overview' },
                    { value: 'analytics', icon: 'trending-up', name: 'Analytics', desc: 'Detailed analytics page' },
                    { value: 'reports', icon: 'file-text', name: 'Reports', desc: 'Report generation' },
                    { value: 'users', icon: 'users', name: 'User Management', desc: 'User administration' },
                    { value: 'settings', icon: 'settings', name: 'System Settings', desc: 'Configuration panel' }
                ]
            },

            'ecommerce': {
                sections: [
                    { value: 'header', icon: 'shopping-cart', name: 'Store Header', desc: 'Store navigation with cart' },
                    { value: 'hero', icon: 'tag', name: 'Hero Banner', desc: 'Promotional hero section' },
                    { value: 'products', icon: 'package', name: 'Product Grid', desc: 'Product showcase grid' },
                    { value: 'categories', icon: 'grid-3x3', name: 'Categories', desc: 'Product categories' },
                    { value: 'featured', icon: 'star', name: 'Featured Products', desc: 'Highlighted products' },
                    { value: 'cart', icon: 'shopping-cart', name: 'Shopping Cart', desc: 'Cart summary' },
                    { value: 'checkout', icon: 'credit-card', name: 'Checkout', desc: 'Purchase process' },
                    { value: 'footer', icon: 'layout', name: 'Store Footer', desc: 'Footer with links' }
                ],
                components: [
                    { value: 'product-cards', icon: 'package', name: 'Product Cards', desc: 'Individual product tiles' },
                    { value: 'filters', icon: 'filter', name: 'Product Filters', desc: 'Search and filter tools' },
                    { value: 'search', icon: 'search', name: 'Product Search', desc: 'Search functionality' },
                    { value: 'cart', icon: 'shopping-cart', name: 'Cart Widget', desc: 'Mini cart display' },
                    { value: 'checkout', icon: 'credit-card', name: 'Checkout Form', desc: 'Payment and shipping forms' },
                    { value: 'reviews', icon: 'star', name: 'Product Reviews', desc: 'Customer review system' },
                    { value: 'ratings', icon: 'star', name: 'Star Ratings', desc: 'Product rating display' }
                ],
                pages: [
                    { value: 'homepage', icon: 'home', name: 'Store Home', desc: 'E-commerce homepage' },
                    { value: 'catalog', icon: 'grid-3x3', name: 'Product Catalog', desc: 'Product listing page' },
                    { value: 'product', icon: 'package', name: 'Product Details', desc: 'Individual product page' },
                    { value: 'cart', icon: 'shopping-cart', name: 'Shopping Cart', desc: 'Cart page' },
                    { value: 'checkout', icon: 'credit-card', name: 'Checkout', desc: 'Checkout process' },
                    { value: 'account', icon: 'user', name: 'Customer Account', desc: 'User account area' }
                ]
            },

            'social': {
                sections: [
                    { value: 'header', icon: 'user-circle', name: 'Profile Header', desc: 'User profile and avatar' },
                    { value: 'content', icon: 'type', name: 'Post Content', desc: 'Main post text and media' },
                    { value: 'interactions', icon: 'heart', name: 'Interaction Bar', desc: 'Like, share, comment buttons' },
                    { value: 'comments', icon: 'message-circle', name: 'Comments', desc: 'Comment thread' }
                ],
                components: [
                    { value: 'avatar', icon: 'user-circle', name: 'Profile Picture', desc: 'User avatar component' },
                    { value: 'username', icon: 'at-sign', name: 'Username', desc: 'User handle display' },
                    { value: 'content', icon: 'type', name: 'Post Content', desc: 'Text and media content' },
                    { value: 'like-button', icon: 'heart', name: 'Like Button', desc: 'Heart/like interaction' },
                    { value: 'share-button', icon: 'share', name: 'Share Button', desc: 'Share/repost button' },
                    { value: 'comment-box', icon: 'message-square', name: 'Comment Box', desc: 'Comment input field' }
                ],
                pages: [
                    { value: 'post', icon: 'file-text', name: 'Single Post', desc: 'Individual post view' },
                    { value: 'profile', icon: 'user', name: 'Profile View', desc: 'User profile page' },
                    { value: 'feed', icon: 'list', name: 'Feed View', desc: 'Social media feed' }
                ]
            },

            'pdf': {
                sections: [
                    { value: 'cover', icon: 'file-text', name: 'Cover Page', desc: 'Report title and branding' },
                    { value: 'toc', icon: 'list', name: 'Table of Contents', desc: 'Document navigation' },
                    { value: 'executive', icon: 'briefcase', name: 'Executive Summary', desc: 'Key findings overview' },
                    { value: 'charts', icon: 'bar-chart', name: 'Data Charts', desc: 'Visual data representation' },
                    { value: 'tables', icon: 'table', name: 'Data Tables', desc: 'Detailed data tables' },
                    { value: 'appendix', icon: 'paperclip', name: 'Appendix', desc: 'Supporting information' }
                ],
                components: [
                    { value: 'headers', icon: 'type', name: 'Section Headers', desc: 'Document section titles' },
                    { value: 'charts', icon: 'pie-chart', name: 'Chart Components', desc: 'Various chart types' },
                    { value: 'tables', icon: 'table', name: 'Data Tables', desc: 'Formatted data tables' },
                    { value: 'graphs', icon: 'trending-up', name: 'Graphs', desc: 'Line and area graphs' },
                    { value: 'infographics', icon: 'image', name: 'Infographics', desc: 'Visual information displays' },
                    { value: 'page-numbers', icon: 'hash', name: 'Page Numbers', desc: 'Page numbering system' },
                    { value: 'footnotes', icon: 'bookmark', name: 'Footnotes', desc: 'Reference annotations' }
                ],
                pages: [
                    { value: 'cover', icon: 'file', name: 'Cover Page', desc: 'Title page' },
                    { value: 'toc', icon: 'list', name: 'Table of Contents', desc: 'Content index' },
                    { value: 'content', icon: 'file-text', name: 'Content Pages', desc: 'Main report content' },
                    { value: 'bibliography', icon: 'book', name: 'Bibliography', desc: 'References and sources' }
                ]
            },

            'ppt': {
                sections: [
                    { value: 'title', icon: 'type', name: 'Title Slide', desc: 'Presentation opening slide' },
                    { value: 'content', icon: 'square', name: 'Content Slides', desc: 'Main presentation slides' },
                    { value: 'dividers', icon: 'minus', name: 'Section Dividers', desc: 'Section break slides' },
                    { value: 'conclusion', icon: 'check-circle', name: 'Conclusion', desc: 'Closing slide' }
                ],
                components: [
                    { value: 'title-blocks', icon: 'type', name: 'Title Blocks', desc: 'Slide title elements' },
                    { value: 'bullets', icon: 'list', name: 'Bullet Points', desc: 'List formatting' },
                    { value: 'images', icon: 'image', name: 'Image Layouts', desc: 'Photo and graphic layouts' },
                    { value: 'charts', icon: 'bar-chart', name: 'Presentation Charts', desc: 'Data visualization' },
                    { value: 'diagrams', icon: 'git-branch', name: 'Diagrams', desc: 'Process and flow diagrams' },
                    { value: 'notes', icon: 'sticky-note', name: 'Speaker Notes', desc: 'Presentation notes' }
                ],
                pages: [
                    { value: 'title', icon: 'play', name: 'Title Slide', desc: 'Opening title slide' },
                    { value: 'agenda', icon: 'list', name: 'Agenda', desc: 'Presentation outline' },
                    { value: 'content', icon: 'square', name: 'Content Slides', desc: 'Main content slides' },
                    { value: 'thankyou', icon: 'heart', name: 'Thank You', desc: 'Closing slide' }
                ]
            }
        };

        // Event Listeners
        apiSettingsBtn.addEventListener('click', () => {
            apiSettingsModal.classList.remove('hidden');
        });

        closeModalBtn.addEventListener('click', () => {
            apiSettingsModal.classList.add('hidden');
        });

        saveSettingsBtn.addEventListener('click', saveSettings);
        generateBtn.addEventListener('click', startGeneration);
        mobileMenuBtn.addEventListener('click', toggleMobileSidebar);
        mobileOverlay.addEventListener('click', closeMobileSidebar);

        // Initialize
        initializeButtonGroups();
        loadSettings();
        updateEmptyState();

        // Button Group Functions
        function initializeButtonGroups() {
            // Input Method Buttons
            document.querySelectorAll('.input-method-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.input-method-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    inputMethod = btn.dataset.value;
                    toggleInputMethod();
                });
            });

            // Reference Type Buttons - REMOVED (now using unified upload)
            // The unified upload area will handle all file types automatically
            
            // Make upload area clickable
            const fileUploadArea = document.getElementById('fileUploadArea');
            const referenceFileInput = document.getElementById('referenceFile');
            
            if (fileUploadArea && referenceFileInput) {
                fileUploadArea.addEventListener('click', () => {
                    referenceFileInput.click();
                });
                
                // Handle drag and drop
                fileUploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    fileUploadArea.classList.add('border-opacity-60');
                });
                
                fileUploadArea.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    fileUploadArea.classList.remove('border-opacity-60');
                });
                
                fileUploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    fileUploadArea.classList.remove('border-opacity-60');
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        referenceFileInput.files = files;
                        handleFileUpload(files);
                    }
                });
                
                // Handle file selection
                referenceFileInput.addEventListener('change', (e) => {
                    const files = e.target.files;
                    if (files.length > 0) {
                        handleFileUpload(files);
                    }
                });
            }
            
            // Function to handle uploaded files
            function handleFileUpload(files) {
                const fileList = Array.from(files);
                const fileNames = fileList.map(file => file.name).join(', ');
                
                // Update upload area to show selected files
                const uploadArea = document.getElementById('fileUploadArea');
                if (uploadArea && fileList.length > 0) {
                    uploadArea.innerHTML = `
                        <i data-lucide="check-circle" class="w-8 h-8 text-green-400 mx-auto mb-2"></i>
                        <h4 class="text-sm font-medium text-white text-opacity-80 mb-2">Files Selected</h4>
                        <p class="text-xs text-white text-opacity-60 mb-2">${fileList.length} file(s) selected</p>
                        <p class="text-xs text-white text-opacity-50 truncate">${fileNames}</p>
                        <button class="glass-button text-xs px-3 py-1 mt-2 rounded" onclick="clearFileSelection()">
                            Change Files
                        </button>
                    `;
                    lucide.createIcons();
                }
            }
            
            // Function to clear file selection
            function clearFileSelection() {
                const uploadArea = document.getElementById('fileUploadArea');
                const fileInput = document.getElementById('referenceFile');
                
                if (fileInput) fileInput.value = '';
                
                if (uploadArea) {
                    uploadArea.innerHTML = `
                        <i data-lucide="upload-cloud" class="w-12 h-12 text-white text-opacity-40 mx-auto mb-3"></i>
                        <h4 class="text-sm font-medium text-white text-opacity-80 mb-2">Upload Reference Files</h4>
                        <p class="text-xs text-white text-opacity-60 mb-3">
                            Drag & drop or click to upload HTML files, CSS files, or entire folders
                        </p>
                        <div class="flex items-center justify-center gap-4 text-xs text-white text-opacity-50">
                            <span class="flex items-center gap-1">
                                <i data-lucide="code" class="w-3 h-3"></i>
                                HTML
                            </span>
                            <span class="flex items-center gap-1">
                                <i data-lucide="paintbrush" class="w-3 h-3"></i>
                                CSS
                            </span>
                            <span class="flex items-center gap-1">
                                <i data-lucide="folder" class="w-3 h-3"></i>
                                Folders
                            </span>
                        </div>
                    `;
                    lucide.createIcons();
                }
            }

            // Template Type Dropdown
            const templateTypeSelect = document.getElementById('templateTypeSelect');
            templateTypeSelect.addEventListener('change', () => {
                selectedTemplateType = templateTypeSelect.value;
                updateComponentsForTemplateType();
            });

            // Component Containers - Event delegation will be handled in updateComponentsForTemplateType

            // Variation Count Buttons
            document.querySelectorAll('.variation-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.variation-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });
        }

        function toggleInputMethod() {
            const promptInput = document.getElementById('promptInput');
            const referenceInput = document.getElementById('referenceInput');
            
            if (inputMethod === 'prompt') {
                promptInput.classList.remove('hidden');
                referenceInput.classList.add('hidden');
            } else {
                promptInput.classList.add('hidden');
                referenceInput.classList.remove('hidden');
            }
        }

        function updateComponentsForTemplateType() {
            const sectionsContainer = document.getElementById('sectionsContainer');
            const componentsContainer = document.getElementById('componentsContainer');
            const pagesContainer = document.getElementById('pagesContainer');
            
            // Clear all containers
            sectionsContainer.innerHTML = '';
            componentsContainer.innerHTML = '';
            pagesContainer.innerHTML = '';
            
            if (!selectedTemplateType || !TEMPLATE_COMPONENTS[selectedTemplateType]) {
                // Show placeholder when no template type is selected
                sectionsContainer.innerHTML = '<div class="text-center text-white text-opacity-50 py-4"><p class="text-sm">Select a template type first...</p></div>';
                componentsContainer.innerHTML = '<div class="text-center text-white text-opacity-50 py-4"><p class="text-sm">Select a template type first...</p></div>';
                pagesContainer.innerHTML = '<div class="text-center text-white text-opacity-50 py-4"><p class="text-sm">Select a template type first...</p></div>';
                return;
            }

            const templateConfig = TEMPLATE_COMPONENTS[selectedTemplateType];

            // Populate Sections container
            if (templateConfig.sections && templateConfig.sections.length > 0) {
                templateConfig.sections.forEach(section => {
                    const item = createMultiSelectItem(`section-${section.value}`, section.name, 'sectionsContainer');
                    sectionsContainer.appendChild(item);
                });
            } else {
                sectionsContainer.innerHTML = '<div class="text-center text-white text-opacity-50 py-4"><p class="text-sm">No sections available</p></div>';
            }

            // Populate Components container
            if (templateConfig.components && templateConfig.components.length > 0) {
                templateConfig.components.forEach(component => {
                    const item = createMultiSelectItem(`component-${component.value}`, component.name, 'componentsContainer');
                    componentsContainer.appendChild(item);
                });
            } else {
                componentsContainer.innerHTML = '<div class="text-center text-white text-opacity-50 py-4"><p class="text-sm">No components available</p></div>';
            }

            // Populate Pages container
            if (templateConfig.pages && templateConfig.pages.length > 0) {
                templateConfig.pages.forEach(page => {
                    const item = createMultiSelectItem(`page-${page.value}`, page.name, 'pagesContainer');
                    pagesContainer.appendChild(item);
                });
            } else {
                pagesContainer.innerHTML = '<div class="text-center text-white text-opacity-50 py-4"><p class="text-sm">No pages available</p></div>';
            }

            // Clear previous selections
            selectedComponents.clear();

            // Auto-select key components
            autoSelectKeyComponents();
            updateGenerateButton();
        }

        function createMultiSelectItem(value, name, containerId) {
            const item = document.createElement('div');
            item.className = 'multi-select-item';
            item.innerHTML = `
                <input type="checkbox" id="${value}" value="${value}" data-container="${containerId}">
                <label for="${value}" class="multi-select-item-label">${name}</label>
            `;

            // Add event listeners
            const checkbox = item.querySelector('input');
            checkbox.addEventListener('change', () => {
                if (checkbox.checked) {
                    selectedComponents.add(value);
                    item.classList.add('selected');
                } else {
                    selectedComponents.delete(value);
                    item.classList.remove('selected');
                }
                updateGenerateButton();
            });

            // Make the whole item clickable
            item.addEventListener('click', (e) => {
                if (e.target.type !== 'checkbox') {
                    checkbox.checked = !checkbox.checked;
                    checkbox.dispatchEvent(new Event('change'));
                }
            });

            return item;
        }

        function autoSelectKeyComponents() {
            // Auto-select essential components for each template type
            const autoSelectMap = {
                'landing': ['section-hero', 'section-features', 'component-navbar'],
                'website': ['section-hero', 'section-about', 'section-contact', 'component-navbar'],
                'webapp': ['section-dashboard', 'section-sidebar', 'component-navbar'],
                'mobile': ['section-header', 'section-content', 'component-buttons'],
                'saas': ['section-hero', 'section-features', 'section-pricing', 'component-navbar'],
                'dashboard': ['section-sidebar', 'section-widgets', 'component-kpi-cards'],
                'ecommerce': ['section-header', 'section-products', 'component-product-cards'],
                'social': ['section-header', 'section-content', 'component-avatar'],
                'pdf': ['section-cover', 'section-toc', 'component-headers'],
                'ppt': ['section-title', 'section-content', 'component-title-blocks']
            };

            const autoSelect = autoSelectMap[selectedTemplateType] || [];
            
            autoSelect.forEach(componentKey => {
                const checkbox = document.getElementById(componentKey);
                if (checkbox) {
                    checkbox.checked = true;
                    selectedComponents.add(componentKey);
                    const item = checkbox.closest('.multi-select-item');
                    if (item) {
                        item.classList.add('selected');
                    }
                }
            });
        }

        function updateGenerateButton() {
            const hasSelection = selectedComponents.size > 0 || selectedTemplateType;
            generateBtn.disabled = !hasSelection;
            
            if (hasSelection) {
                generateBtn.classList.remove('opacity-50');
            } else {
                generateBtn.classList.add('opacity-50');
            }
        }

        function startGeneration() {
            if (selectedComponents.size === 0 && !selectedTemplateType) {
                showToast('Please select components or a template type to generate', 'warning');
                return;
            }

            const apiKey = localStorage.getItem('openRouterApiKey');
            if (!apiKey) {
                showToast('Please set your OpenRouter API key in the settings first.', 'error');
                return;
            }

            // Set loading state
            isGenerating = true;
            const generateBtn = document.getElementById('generateBtn');
            generateBtn.classList.add('button-loading');
            generateBtn.disabled = true;
            
            updateEmptyState();
            
            // Show progress with enhanced UI
            headerProgressContainer.classList.remove('hidden');
            document.getElementById('headerStatusText').textContent = 'Initializing...';
            document.getElementById('headerStatusText').className = 'text-sm font-medium status-generating';
            
            // Start generation process
            generateTemplates().finally(() => {
                // Reset button state
                generateBtn.classList.remove('button-loading');
                generateBtn.disabled = false;
                
                // Hide progress after 3 seconds if completed
                setTimeout(() => {
                    if (!isGenerating) {
                        headerProgressContainer.classList.add('hidden');
                    }
                }, 3000);
            });
        }

        async function generateTemplates() {
            const mainPrompt = document.getElementById('mainPrompt').value.trim();
            const customGeneration = document.getElementById('customGeneration').value.trim();
            const variationCount = getSelectedVariationCount();
            
            // Combine main prompt with custom generation requirements
            let enhancedPrompt = mainPrompt;
            if (customGeneration) {
                enhancedPrompt = mainPrompt ? 
                    `${mainPrompt} | Additional Requirements: ${customGeneration}` : 
                    `Custom Requirements: ${customGeneration}`;
            }
            
            try {
                // Generate templates for each selected component
                let totalComponents = selectedComponents.size;
                let totalTemplates = totalComponents * variationCount;
                let completedTemplates = 0;
                
                // Update initial progress
                document.getElementById('headerCompletedCount').textContent = '0';
                document.getElementById('headerTotalCount').textContent = totalTemplates;
                
                for (const componentKey of selectedComponents) {
                    const [category, componentType] = componentKey.split('-');
                    
                    // Update component status
                    document.getElementById('headerStatusText').innerHTML = `
                        Generating ${componentType}
                        <span class="loading-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </span>
                    `;
                    document.getElementById('headerStatusText').className = 'text-sm font-medium status-generating';
                    
                    // Create placeholder cards first for better UX
                    const placeholderCards = [];
                    for (let i = 0; i < variationCount; i++) {
                        const placeholderCard = createLoadingTemplateCard(category, componentType, i + 1);
                        templatesGrid.appendChild(placeholderCard);
                        placeholderCards.push(placeholderCard);
                    }
                    
                    // Generate variations for this component
                    for (let i = 0; i < variationCount; i++) {
                        try {
                            // Generate the actual template
                            await generateSingleTemplate(category, componentType, i + 1, enhancedPrompt, placeholderCards[i]);
                            completedTemplates++;
                            
                            // Update progress
                            document.getElementById('headerCompletedCount').textContent = completedTemplates;
                            
                            // Rate limiting with visual feedback
                            if (completedTemplates < totalTemplates) {
                                document.getElementById('headerStatusText').innerHTML = `
                                    Rate limiting
                                    <span class="loading-dots">
                                        <span></span>
                                        <span></span>
                                        <span></span>
                                    </span>
                                `;
                                await new Promise(resolve => setTimeout(resolve, 1500));
                            }
                        } catch (error) {
                            console.error(`Failed to generate ${componentType} v${i + 1}:`, error);
                            // Replace placeholder with error state
                            placeholderCards[i].innerHTML = `
                                <div class="template-card-header bg-red-500 bg-opacity-20">
                                    <span class="text-xs font-medium text-red-400">Error: ${componentType} v${i + 1}</span>
                                    <button class="glass-button p-1.5 rounded retry-btn" onclick="this.parentElement.parentElement.remove()">
                                        <i data-lucide="x" class="w-3 h-3 aurora-icon"></i>
                                    </button>
                                </div>
                                <div class="preview-frame bg-red-500 bg-opacity-10 flex items-center justify-center">
                                    <span class="text-xs text-red-400">Generation failed</span>
                                </div>
                            `;
                            lucide.createIcons();
                        }
                    }
                }
                
                // Generation complete
                document.getElementById('headerStatusText').innerHTML = `
                    Complete! Generated ${completedTemplates} templates
                `;
                document.getElementById('headerStatusText').className = 'text-sm font-medium status-complete';
                showToast(`Generated ${completedTemplates} templates successfully!`, 'success');
                
            } catch (error) {
                console.error('Generation error:', error);
                document.getElementById('headerStatusText').innerHTML = 'Generation failed';
                document.getElementById('headerStatusText').className = 'text-sm font-medium status-error';
                showToast('Generation failed. Please try again.', 'error');
            } finally {
                isGenerating = false;
                updateEmptyState();
            }
        }

        function createLoadingTemplateCard(category, componentType, variation) {
            const templateId = `loading-${category}-${componentType}-${variation}-${Date.now()}`;
            const templateName = `${componentType.charAt(0).toUpperCase() + componentType.slice(1)} v${variation}`;
            
            const templateCard = document.createElement('div');
            templateCard.className = 'template-card template-card-loading';
            templateCard.innerHTML = `
                <div class="template-card-header">
                    <span class="text-xs font-medium text-white truncate flex-1" title="${templateName}">${templateName}</span>
                    <div class="flex items-center space-x-1">
                        <div class="w-6 h-6 flex items-center justify-center">
                            <div class="w-3 h-3 border border-white border-opacity-30 border-t-white rounded-full animate-spin"></div>
                        </div>
                    </div>
                </div>
                <div class="preview-frame bg-black bg-opacity-20 flex items-center justify-center">
                    <div class="text-center">
                        <div class="w-8 h-8 border-2 border-purple-500 border-t-transparent rounded-full animate-spin mx-auto mb-2"></div>
                        <span class="text-xs text-white text-opacity-60">Generating...</span>
                    </div>
                </div>
            `;
            
            return templateCard;
        }

        async function generateSingleTemplate(category, componentType, variation, basePrompt, placeholderCard = null) {
            try {
                const apiKey = localStorage.getItem('openRouterApiKey');
                const model = document.getElementById('modalAiModel') ? document.getElementById('modalAiModel').value : 'deepseek/deepseek-chat-v3-0324:free';
                
                if (!apiKey) {
                    throw new Error('API key not found. Please set your OpenRouter API key in settings.');
                }

                // Create enhanced prompt for specific component
                const componentPrompt = `${basePrompt}

COMPONENT FOCUS: Generate a ${componentType} ${category} component.
- Make it modular and reusable
- Focus on modern UI/UX principles
- Ensure responsive design
- Include appropriate styling and interactions`;

                console.log(`🔄 Generating ${componentType} v${variation}:`, componentPrompt);

                // Generate HTML using AI
                const htmlContent = await generateHtmlDesign(componentPrompt, apiKey, model, 5);
                
                // Create template metadata
                const templateId = `${category}-${componentType}-${variation}-${Date.now()}`;
                const templateName = `${componentType.charAt(0).toUpperCase() + componentType.slice(1)} v${variation}`;
                const filename = `${componentType.toLowerCase()}-v${variation}-${Date.now()}.html`;
                
                // Create or update template card
                let templateCard;
                
                if (placeholderCard) {
                    // Replace placeholder content
                    templateCard = placeholderCard;
                    templateCard.classList.remove('template-card-loading');
                } else {
                    // Create new card (fallback)
                    templateCard = document.createElement('div');
                    templateCard.className = 'template-card';
                    templatesGrid.appendChild(templateCard);
                }
                
                // Set final card content with enhanced header options
                templateCard.innerHTML = `
                    <div class="selection-checkbox" data-template-id="${templateId}">
                        <i data-lucide="check" class="w-3 h-3" style="display: none;"></i>
                    </div>
                    <div class="template-card-header">
                        <span class="text-xs font-medium text-white truncate flex-1" title="${templateName}">${templateName}</span>
                        <div class="flex items-center space-x-1">
                            <button class="glass-button p-1.5 rounded view-code-btn" title="See Code" data-template-id="${templateId}">
                                <i data-lucide="code" class="w-3 h-3 aurora-icon"></i>
                            </button>
                            <button class="glass-button p-1.5 rounded download-btn" title="Download" data-template-id="${templateId}">
                                <i data-lucide="download" class="w-3 h-3 aurora-icon"></i>
                            </button>
                            <button class="glass-button p-1.5 rounded open-new-btn" title="Open in New Window" data-template-id="${templateId}">
                                <i data-lucide="external-link" class="w-3 h-3 aurora-icon"></i>
                            </button>
                            <button class="glass-button p-1.5 rounded fullscreen-btn" title="Focus - Expanded View" data-template-id="${templateId}">
                                <i data-lucide="maximize-2" class="w-3 h-3 aurora-icon"></i>
                            </button>
                        </div>
                    </div>
                    <div class="preview-frame">
                        <iframe class="w-full h-full" srcdoc="${escapeHtml(htmlContent)}"></iframe>
                    </div>
                `;
                
                lucide.createIcons();
                
                // Add event listeners for all buttons
                const checkbox = templateCard.querySelector('.selection-checkbox');
                const viewCodeBtn = templateCard.querySelector('.view-code-btn');
                const downloadBtn = templateCard.querySelector('.download-btn');
                const openNewBtn = templateCard.querySelector('.open-new-btn');
                const fullscreenBtn = templateCard.querySelector('.fullscreen-btn');
                
                checkbox.addEventListener('click', () => toggleTemplateSelection(templateId, checkbox));
                viewCodeBtn.addEventListener('click', () => viewTemplateCode(templateId));
                downloadBtn.addEventListener('click', () => downloadTemplate(templateId));
                openNewBtn.addEventListener('click', () => openTemplateInNewWindow(templateId));
                fullscreenBtn.addEventListener('click', () => openTemplateFullscreen(templateId));
                
                // Store template data
                generatedTemplates.push({
                    id: templateId,
                    name: templateName,
                    filename: filename,
                    category: category,
                    type: componentType,
                    variation: variation,
                    prompt: componentPrompt,
                    html: htmlContent
                });
                
                console.log(`✅ Generated ${templateName} successfully`);
                updateEmptyState();
                
                // Add success animation
                templateCard.style.animation = 'slideInUp 0.3s ease-out';
                
            } catch (error) {
                console.error(`❌ Failed to generate ${componentType} v${variation}:`, error);
                
                // Update placeholder with error state if it exists
                if (placeholderCard) {
                    placeholderCard.classList.remove('template-card-loading');
                    placeholderCard.innerHTML = `
                        <div class="template-card-header bg-red-500 bg-opacity-20 border border-red-500 border-opacity-30">
                            <span class="text-xs font-medium text-red-400 truncate flex-1">Error: ${componentType} v${variation}</span>
                            <button class="glass-button p-1.5 rounded retry-btn text-red-400 hover:text-red-300" onclick="retryGeneration('${category}', '${componentType}', ${variation}, this)" title="Retry Generation">
                                <i data-lucide="refresh-cw" class="w-3 h-3"></i>
                            </button>
                            <button class="glass-button p-1.5 rounded" onclick="this.parentElement.parentElement.remove()" title="Remove">
                                <i data-lucide="x" class="w-3 h-3"></i>
                            </button>
                        </div>
                        <div class="preview-frame bg-red-500 bg-opacity-10 flex items-center justify-center text-center p-4">
                            <div>
                                <i data-lucide="alert-circle" class="w-8 h-8 text-red-400 mx-auto mb-2"></i>
                                <p class="text-xs text-red-400 mb-1">Generation Failed</p>
                                <p class="text-xs text-red-300 opacity-70">${error.message}</p>
                            </div>
                        </div>
                    `;
                    lucide.createIcons();
                }
                
                showToast(`Failed to generate ${componentType} v${variation}: ${error.message}`, 'error');
                throw error; // Re-throw to be caught by the caller
            }
        }

        // Retry function for failed generations
        window.retryGeneration = async function(category, componentType, variation, buttonElement) {
            const card = buttonElement.closest('.template-card');
            const basePrompt = document.getElementById('mainPrompt').value.trim();
            const customGeneration = document.getElementById('customGeneration').value.trim();
            
            let enhancedPrompt = basePrompt;
            if (customGeneration) {
                enhancedPrompt = basePrompt ? 
                    `${basePrompt} | Additional Requirements: ${customGeneration}` : 
                    `Custom Requirements: ${customGeneration}`;
            }
            
            // Show loading state
            card.classList.add('template-card-loading');
            card.innerHTML = `
                <div class="template-card-header">
                    <span class="text-xs font-medium text-white truncate flex-1">Retrying: ${componentType} v${variation}</span>
                    <div class="flex items-center space-x-1">
                        <div class="w-6 h-6 flex items-center justify-center">
                            <div class="w-3 h-3 border border-white border-opacity-30 border-t-white rounded-full animate-spin"></div>
                        </div>
                    </div>
                </div>
                <div class="preview-frame bg-black bg-opacity-20 flex items-center justify-center">
                    <div class="text-center">
                        <div class="w-8 h-8 border-2 border-purple-500 border-t-transparent rounded-full animate-spin mx-auto mb-2"></div>
                        <span class="text-xs text-white text-opacity-60">Retrying...</span>
                    </div>
                </div>
            `;
            
            try {
                await generateSingleTemplate(category, componentType, variation, enhancedPrompt, card);
                showToast(`Successfully generated ${componentType} v${variation}`, 'success');
            } catch (error) {
                console.error('Retry failed:', error);
            }
        }

        // Add CSS animation for new cards
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInUp {
                from {
                    transform: translateY(20px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
        `;
        document.head.appendChild(style);

        // ============================================
        // TEMPLATE ACTION FUNCTIONS
        // ============================================

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function viewTemplateCode(templateId) {
            const template = generatedTemplates.find(t => t.id === templateId);
            if (template) {
                // Create code viewer modal
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';
                modal.innerHTML = `
                    <div class="glass-card w-full max-w-4xl max-h-[90vh] flex flex-col">
                        <div class="flex items-center justify-between p-4 border-b border-white border-opacity-20">
                            <h3 class="text-lg font-semibold text-white">${template.name} - Source Code</h3>
                            <button class="close-modal-btn glass-button p-2 rounded">
                                <i data-lucide="x" class="w-5 h-5 aurora-icon"></i>
                            </button>
                        </div>
                        <div class="flex-1 overflow-hidden p-4">
                            <textarea class="aurora-input w-full h-full resize-none font-mono text-sm" readonly>${template.html}</textarea>
                        </div>
                        <div class="p-4 border-t border-white border-opacity-20 flex gap-2">
                            <button class="copy-code-btn aurora-button px-4 py-2 rounded">
                                <i data-lucide="copy" class="w-4 h-4 inline mr-2"></i>
                                Copy Code
                            </button>
                            <button class="download-code-btn glass-button px-4 py-2 rounded">
                                <i data-lucide="download" class="w-4 h-4 inline mr-2"></i>
                                Download
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                lucide.createIcons();
                
                // Add event listeners
                modal.querySelector('.close-modal-btn').addEventListener('click', () => modal.remove());
                modal.querySelector('.copy-code-btn').addEventListener('click', () => {
                    navigator.clipboard.writeText(template.html).then(() => {
                        showToast('Code copied to clipboard!', 'success');
                    });
                });
                modal.querySelector('.download-code-btn').addEventListener('click', () => {
                    downloadTemplate(templateId);
                });
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.remove();
                });
            }
        }

        function downloadTemplate(templateId) {
            const template = generatedTemplates.find(t => t.id === templateId);
            if (template) {
                try {
                    const blob = new Blob([template.html], { type: 'text/html' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = template.filename;
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showToast(`Downloaded ${template.name}`, 'success');
                } catch (error) {
                    console.error('Download failed:', error);
                    showToast('Download failed', 'error');
                }
            }
        }

        function openTemplateInNewWindow(templateId) {
            const template = generatedTemplates.find(t => t.id === templateId);
            if (template) {
                const newWindow = window.open('', '_blank');
                if (newWindow) {
                    newWindow.document.write(template.html);
                    newWindow.document.title = template.name;
                    newWindow.document.close();
                } else {
                    showToast('Popup blocked. Please allow popups for this site.', 'error');
                }
            }
        }

        function openTemplateFullscreen(templateId) {
            const template = generatedTemplates.find(t => t.id === templateId);
            if (template) {
                // Create fullscreen viewer
                const viewer = document.createElement('div');
                viewer.className = 'fixed inset-0 bg-black z-50 flex flex-col';
                viewer.innerHTML = `
                    <div class="glass-card border-b border-white border-opacity-20 p-4 flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-white">${template.name} - Focus View</h3>
                        <button class="close-fullscreen-btn glass-button p-2 rounded">
                            <i data-lucide="minimize-2" class="w-5 h-5 aurora-icon"></i>
                        </button>
                    </div>
                    <div class="flex-1 p-4">
                        <iframe class="w-full h-full border border-white border-opacity-20 rounded-lg" srcdoc="${escapeHtml(template.html)}"></iframe>
                    </div>
                `;
                
                document.body.appendChild(viewer);
                lucide.createIcons();
                
                viewer.querySelector('.close-fullscreen-btn').addEventListener('click', () => viewer.remove());
                document.addEventListener('keydown', function escapeHandler(e) {
                    if (e.key === 'Escape') {
                        viewer.remove();
                        document.removeEventListener('keydown', escapeHandler);
                    }
                });
            }
        }

        function toggleTemplateSelection(templateId, checkbox) {
            if (selectedTemplates.has(templateId)) {
                selectedTemplates.delete(templateId);
                checkbox.classList.remove('selected');
                checkbox.querySelector('i').style.display = 'none';
            } else {
                selectedTemplates.add(templateId);
                checkbox.classList.add('selected');
                checkbox.querySelector('i').style.display = 'block';
            }
            
            updateMergeControls();
        }

        function updateMergeControls() {
            const selectedCount = selectedTemplates.size;
            
            if (selectedCount > 0) {
                mergeControls.classList.add('visible');
                mergeControls.querySelector('.selected-count').textContent = `${selectedCount} components selected`;
            } else {
                mergeControls.classList.remove('visible');
            }
        }

        function getSelectedVariationCount() {
            const activeBtn = document.querySelector('.variation-btn.active');
            return activeBtn ? parseInt(activeBtn.dataset.value) : 2;
        }

        function updateEmptyState() {
            if (generatedTemplates.length === 0 && !isGenerating) {
                emptyState.classList.remove('hidden');
                resultsContainer.classList.add('hidden');
            } else {
                emptyState.classList.add('hidden');
                resultsContainer.classList.remove('hidden');
            }
        }

        function toggleMobileSidebar() {
            sidebar.classList.add('open');
            mobileOverlay.classList.remove('hidden');
        }

        function closeMobileSidebar() {
            sidebar.classList.remove('open');
            mobileOverlay.classList.add('hidden');
        }

        function loadSettings() {
            const savedApiKey = localStorage.getItem('openRouterApiKey');
            if (savedApiKey) {
                document.getElementById('apiKey').value = savedApiKey;
            }
        }

        function saveSettings() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                showToast('Please enter your OpenRouter API key', 'error');
                return;
            }
            
            localStorage.setItem('openRouterApiKey', apiKey);
            apiSettingsModal.classList.add('hidden');
            showToast('Settings saved successfully!', 'success');
        }

        function showToast(message, type = 'info') {
            // Remove existing toasts
            document.querySelectorAll('.toast').forEach(toast => toast.remove());
            
            const colors = {
                info: 'var(--aurora-cyan)',
                success: '#4ade80',
                warning: '#fbbf24',
                error: '#ef4444'
            };
            
            const icons = {
                info: 'info',
                success: 'check-circle-2',
                warning: 'alert-triangle',
                error: 'x-circle'
            };
            
            const toast = document.createElement('div');
            toast.className = 'glass-card fixed bottom-6 right-6 px-4 py-3 flex items-center gap-3 z-50 fade-up toast';
            toast.style.borderColor = colors[type];
            toast.innerHTML = `
                <i data-lucide="${icons[type]}" class="w-5 h-5 aurora-icon" style="color: ${colors[type]}"></i>
                <span class="text-sm font-medium text-white">${message}</span>
            `;
            
            document.body.appendChild(toast);
            lucide.createIcons();
            
            // Auto-remove after delay
            setTimeout(() => {
                toast.remove();
            }, 5000);
        }

        // Handle window resize for responsive behavior
        window.addEventListener('resize', () => {
            if (window.innerWidth >= 1024) {
                sidebar.classList.remove('open');
                mobileOverlay.classList.add('hidden');
            }
        });

        // ============================================
        // ENHANCED FEATURES - AUTO-SAVE & CONFIGURATION MANAGEMENT
        // ============================================

        let autoSaveTimer;
        let lastSavedConfig = '';

        // Auto-save configuration every 30 seconds
        function initializeAutoSave() {
            autoSaveTimer = setInterval(() => {
                saveCurrentConfiguration();
            }, 30000); // 30 seconds

            // Also save when user makes changes
            document.addEventListener('change', debounce(saveCurrentConfiguration, 2000));
            document.addEventListener('input', debounce(saveCurrentConfiguration, 5000));
        }

        // Debounce function to limit frequency of saves
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Save current configuration to localStorage
        function saveCurrentConfiguration() {
            const config = getCurrentConfiguration();
            const configString = JSON.stringify(config);
            
            // Only save if configuration has changed
            if (configString !== lastSavedConfig) {
                localStorage.setItem('templateBuilderAutoSave', configString);
                localStorage.setItem('templateBuilderAutoSaveTime', new Date().toISOString());
                lastSavedConfig = configString;
                updateAutoSaveStatus('saved');
            }
        }

        // Get current form configuration
        function getCurrentConfiguration() {
            return {
                inputMethod: inputMethod,
                mainPrompt: document.getElementById('mainPrompt').value,
                templateType: document.getElementById('templateTypeSelect').value,
                selectedComponents: Array.from(selectedComponents),
                customGeneration: document.getElementById('customGeneration').value,
                variationCount: getSelectedVariationCount(),
                outputFormat: getSelectedValue('.format-btn.active'),
                cssFramework: getSelectedValue('.framework-btn.active'),
                qualityLevel: getSelectedValue('.quality-btn.active'),
                timestamp: new Date().toISOString()
            };
        }

        // Helper function to get selected button value
        function getSelectedValue(selector) {
            const activeBtn = document.querySelector(selector);
            return activeBtn ? activeBtn.dataset.value : null;
        }

        // Load configuration from data
        function loadConfiguration(config) {
            try {
                // Input method
                if (config.inputMethod) {
                    inputMethod = config.inputMethod;
                    updateInputMethodButtons();
                    toggleInputMethod();
                }

                // Main prompt
                if (config.mainPrompt) {
                    document.getElementById('mainPrompt').value = config.mainPrompt;
                    updateCharacterCount();
                }

                // Template type
                if (config.templateType) {
                    document.getElementById('templateTypeSelect').value = config.templateType;
                    updateComponentsForTemplateType();
                    
                    // Wait for components to be generated before updating selections
                    setTimeout(() => {
                        if (config.selectedComponents && Array.isArray(config.selectedComponents)) {
                            selectedComponents.clear();
                            config.selectedComponents.forEach(comp => selectedComponents.add(comp));
                            updateSelectedComponentsUI();
                        }
                    }, 100);
                } else {
                    // Selected components (only if no template type change)
                    if (config.selectedComponents && Array.isArray(config.selectedComponents)) {
                        selectedComponents.clear();
                        config.selectedComponents.forEach(comp => selectedComponents.add(comp));
                        updateSelectedComponentsUI();
                    }
                }

                // Custom generation
                if (config.customGeneration) {
                    document.getElementById('customGeneration').value = config.customGeneration;
                }

                // Variation count
                if (config.variationCount) {
                    updateButtonGroup('.variation-btn', config.variationCount.toString());
                }

                // Advanced options
                if (config.outputFormat) {
                    updateButtonGroup('.format-btn', config.outputFormat);
                }
                if (config.cssFramework) {
                    updateButtonGroup('.framework-btn', config.cssFramework);
                }
                if (config.qualityLevel) {
                    updateButtonGroup('.quality-btn', config.qualityLevel);
                }

                showToast('Configuration loaded successfully!', 'success');
            } catch (error) {
                console.error('Error loading configuration:', error);
                showToast('Error loading configuration', 'error');
            }
        }

        // Update button group selection
        function updateButtonGroup(selector, value) {
            document.querySelectorAll(selector).forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.value === value) {
                    btn.classList.add('active');
                }
            });
        }

        // Update input method buttons
        function updateInputMethodButtons() {
            document.querySelectorAll('.input-method-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.value === inputMethod) {
                    btn.classList.add('active');
                }
            });
        }

        // Update selected components UI
        function updateSelectedComponentsUI() {
            document.querySelectorAll('.multi-select-item input[type="checkbox"]').forEach(checkbox => {
                const componentKey = checkbox.dataset.component;
                checkbox.checked = selectedComponents.has(componentKey);
                const item = checkbox.closest('.multi-select-item');
                if (checkbox.checked) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        // Update auto-save status indicator
        function updateAutoSaveStatus(status) {
            const statusElement = document.getElementById('autoSaveStatus');
            const statusDot = statusElement.nextElementSibling;
            
            switch (status) {
                case 'saved':
                    statusElement.textContent = 'Auto-saved';
                    statusElement.className = 'text-xs text-green-400 opacity-75';
                    statusDot.className = 'w-2 h-2 bg-green-400 rounded-full';
                    break;
                case 'saving':
                    statusElement.textContent = 'Saving...';
                    statusElement.className = 'text-xs text-yellow-400 opacity-75';
                    statusDot.className = 'w-2 h-2 bg-yellow-400 rounded-full animate-pulse';
                    break;
                case 'error':
                    statusElement.textContent = 'Save error';
                    statusElement.className = 'text-xs text-red-400 opacity-75';
                    statusDot.className = 'w-2 h-2 bg-red-400 rounded-full';
                    break;
            }
        }

        // Export configuration as file
        function exportConfiguration() {
            const config = getCurrentConfiguration();
            const configString = JSON.stringify(config, null, 2);
            const timestamp = new Date().toISOString().slice(0, 10);
            const filename = `template-builder-config-${timestamp}.json`;

            try {
                const blob = new Blob([configString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showToast(`Configuration exported as ${filename}`, 'success');
            } catch (error) {
                console.error('Export error:', error);
                showToast('Error exporting configuration', 'error');
            }
        }

        // Import configuration from file
        function importConfiguration(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const config = JSON.parse(e.target.result);
                    loadConfiguration(config);
                } catch (error) {
                    console.error('Import error:', error);
                    showToast('Invalid configuration file', 'error');
                }
            };
            reader.readAsText(file);
        }

        // ============================================
        // SMART PRESETS
        // ============================================

        const SMART_PRESETS = {
            'saas-startup': {
                inputMethod: 'prompt',
                mainPrompt: 'Modern SaaS startup landing page with clean design, hero section showcasing product benefits, feature highlights with icons, pricing tiers with clear value propositions, customer testimonials with photos, and strong call-to-action buttons for trial signup',
                templateType: 'saas',
                selectedComponents: [
                    // Essential Sections
                    'section-hero', 'section-features', 'section-pricing', 'section-testimonials', 'section-cta', 'section-footer',
                    // Key Components  
                    'component-navbar', 'component-buttons', 'component-forms', 'component-cards', 'component-modals',
                    // Important Pages
                    'page-homepage', 'page-pricing', 'page-signup'
                ],
                customGeneration: 'Focus on conversion optimization with trust signals, social proof, security badges, and clear value propositions. Include trial signup forms and demo request buttons.',
                variationCount: 3,
                outputFormat: 'html',
                cssFramework: 'tailwind',
                qualityLevel: 'balanced'
            },
            'ecommerce-store': {
                inputMethod: 'prompt',
                mainPrompt: 'Professional e-commerce store with attractive product showcase, shopping cart functionality, user account features, advanced search and filtering, customer reviews, and secure checkout process with multiple payment options',
                templateType: 'ecommerce',
                selectedComponents: [
                    // Essential Sections
                    'section-hero', 'section-products', 'section-categories', 'section-testimonials', 'section-footer',
                    // Key Components
                    'component-navbar', 'component-cards', 'component-forms', 'component-buttons', 'component-search', 'component-filters', 'component-cart',
                    // Important Pages
                    'page-homepage', 'page-product', 'page-category', 'page-cart', 'page-checkout', 'page-account'
                ],
                customGeneration: 'Include product filtering, wishlist functionality, customer reviews section, size guides, product zoom, related products, and social media integration for sharing.',
                variationCount: 5,
                outputFormat: 'html',
                cssFramework: 'bootstrap',
                qualityLevel: 'premium'
            },
            'portfolio-creative': {
                inputMethod: 'prompt',
                mainPrompt: 'Creative portfolio website showcasing design work, photography, or artistic projects with elegant gallery layouts, smooth animations, project case studies, and professional bio section',
                templateType: 'website',
                selectedComponents: [
                    // Essential Sections
                    'section-hero', 'section-portfolio', 'section-about', 'section-services', 'section-contact', 'section-footer',
                    // Key Components
                    'component-navbar', 'component-gallery', 'component-cards', 'component-forms', 'component-buttons',
                    // Important Pages
                    'page-homepage', 'page-about', 'page-portfolio', 'page-contact', 'page-project'
                ],
                customGeneration: 'Emphasize visual storytelling with image galleries, smooth scroll animations, project case studies with before/after showcases, client testimonials, and downloadable portfolio PDF.',
                variationCount: 3,
                outputFormat: 'html',
                cssFramework: 'tailwind',
                qualityLevel: 'premium'
            },
            'corporate-business': {
                inputMethod: 'prompt',
                mainPrompt: 'Professional corporate website with company information, comprehensive services overview, team profiles with expertise, client testimonials, contact details, and business credibility elements like certifications and awards',
                templateType: 'website',
                selectedComponents: [
                    // Essential Sections
                    'section-hero', 'section-services', 'section-about', 'section-team', 'section-testimonials', 'section-contact', 'section-footer',
                    // Key Components
                    'component-navbar', 'component-cards', 'component-forms', 'component-buttons', 'component-timeline',
                    // Important Pages
                    'page-homepage', 'page-about', 'page-services', 'page-team', 'page-contact', 'page-blog'
                ],
                customGeneration: 'Include company timeline, client logos showcase, professional certifications display, industry awards, case studies, and leadership team bios with LinkedIn integration.',
                variationCount: 2,
                outputFormat: 'html',
                cssFramework: 'bootstrap',
                qualityLevel: 'balanced'
            }
        };

        // Load smart preset
        function loadSmartPreset(presetKey) {
            const preset = SMART_PRESETS[presetKey];
            if (preset) {
                // Clear any existing preset indicators
                document.querySelectorAll('.preset-btn').forEach(btn => {
                    btn.classList.remove('active', 'preset-active');
                });
                
                // Mark the selected preset as active
                const presetBtn = document.querySelector(`[data-preset="${presetKey}"]`);
                if (presetBtn) {
                    presetBtn.classList.add('active', 'preset-active');
                }
                
                // Load the configuration
                loadConfiguration(preset);
                
                // Store the active preset
                localStorage.setItem('activePreset', presetKey);
                
                // Provide detailed feedback about what was loaded
                const presetName = presetKey.replace('-', ' ').toUpperCase();
                const componentCount = preset.selectedComponents.length;
                const sectionsCount = preset.selectedComponents.filter(c => c.startsWith('section-')).length;
                const componentsCount = preset.selectedComponents.filter(c => c.startsWith('component-')).length; 
                const pagesCount = preset.selectedComponents.filter(c => c.startsWith('page-')).length;
                
                showToast(
                    `${presetName} preset loaded! 
                    📋 ${sectionsCount} sections, 🧩 ${componentsCount} components, 📄 ${pagesCount} pages selected`, 
                    'success'
                );
                
                // Update auto-save status to indicate preset loading
                updateAutoSaveStatus('saved');
                
                console.log(`🎯 Loaded ${presetName} preset:`, {
                    template: preset.templateType,
                    totalComponents: componentCount,
                    breakdown: { sections: sectionsCount, components: componentsCount, pages: pagesCount },
                    selectedComponents: preset.selectedComponents
                });
            } else {
                showToast(`Preset "${presetKey}" not found`, 'error');
            }
        }

        // ============================================
        // CHARACTER COUNTER
        // ============================================

        function updateCharacterCount() {
            const mainPrompt = document.getElementById('mainPrompt');
            const charCount = document.getElementById('promptCharCount');
            if (mainPrompt && charCount) {
                const count = mainPrompt.value.length;
                charCount.textContent = `${count} characters`;
                
                // Color coding based on length
                if (count > 1000) {
                    charCount.className = 'text-xs text-yellow-400';
                } else if (count > 2000) {
                    charCount.className = 'text-xs text-red-400';
                } else {
                    charCount.className = 'text-xs text-white text-opacity-50';
                }
            }
        }

        // ============================================
        // COLLAPSIBLE ADVANCED OPTIONS
        // ============================================

        function initializeAdvancedOptions() {
            const advancedToggle = document.getElementById('advancedToggle');
            const advancedOptions = document.getElementById('advancedOptions');
            const chevron = advancedToggle.querySelector('i[data-lucide="chevron-down"]');

            advancedToggle.addEventListener('click', () => {
                const isHidden = advancedOptions.classList.contains('hidden');
                
                if (isHidden) {
                    advancedOptions.classList.remove('hidden');
                    chevron.style.transform = 'rotate(180deg)';
                } else {
                    advancedOptions.classList.add('hidden');
                    chevron.style.transform = 'rotate(0deg)';
                }
            });
        }

        // ============================================
        // ENHANCED BUTTON GROUP HANDLERS
        // ============================================

        function initializeEnhancedButtonGroups() {
            // Format buttons
            document.querySelectorAll('.format-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.format-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });

            // Framework buttons
            document.querySelectorAll('.framework-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.framework-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });

            // Quality buttons
            document.querySelectorAll('.quality-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.quality-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });

            // Preset buttons
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const presetKey = btn.dataset.preset;
                    loadSmartPreset(presetKey);
                });
            });
        }

        // ============================================
        // CONFIGURATION MANAGEMENT EVENT LISTENERS
        // ============================================

        function initializeConfigurationManagement() {
            // Save configuration button
            document.getElementById('saveConfigBtn').addEventListener('click', () => {
                const config = getCurrentConfiguration();
                const configName = prompt('Enter a name for this configuration:');
                if (configName) {
                    const savedConfigs = JSON.parse(localStorage.getItem('templateBuilderConfigs') || '{}');
                    savedConfigs[configName] = config;
                    localStorage.setItem('templateBuilderConfigs', JSON.stringify(savedConfigs));
                    showToast(`Configuration "${configName}" saved!`, 'success');
                }
            });

            // Export configuration button
            document.getElementById('exportConfigBtn').addEventListener('click', exportConfiguration);

            // Import configuration button
            document.getElementById('importConfigBtn').addEventListener('click', () => {
                document.getElementById('configFile').click();
            });

            // File input for import
            document.getElementById('configFile').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    importConfiguration(file);
                }
                e.target.value = ''; // Reset file input
            });

            // Character counter for main prompt
            const mainPrompt = document.getElementById('mainPrompt');
            if (mainPrompt) {
                mainPrompt.addEventListener('input', updateCharacterCount);
                updateCharacterCount(); // Initial count
            }
        }

        // ============================================
        // LOAD AUTO-SAVED CONFIGURATION ON STARTUP
        // ============================================

        function loadAutoSavedConfiguration() {
            const autoSavedConfig = localStorage.getItem('templateBuilderAutoSave');
            if (autoSavedConfig) {
                try {
                    const config = JSON.parse(autoSavedConfig);
                    const saveTime = localStorage.getItem('templateBuilderAutoSaveTime');
                    
                    if (saveTime) {
                        const timeDiff = Date.now() - new Date(saveTime).getTime();
                        const hoursDiff = timeDiff / (1000 * 60 * 60);
                        
                        // Only auto-load if saved within last 24 hours
                        if (hoursDiff < 24) {
                            loadConfiguration(config);
                            showToast('Previous session restored', 'info');
                        }
                    }
                } catch (error) {
                    console.error('Error loading auto-saved configuration:', error);
                }
            }
        }

        // Restore active preset indicator
        function restoreActivePreset() {
            const activePreset = localStorage.getItem('activePreset');
            if (activePreset) {
                const presetBtn = document.querySelector(`[data-preset="${activePreset}"]`);
                if (presetBtn) {
                    // Clear other preset indicators first
                    document.querySelectorAll('.preset-btn').forEach(btn => {
                        btn.classList.remove('preset-active');
                    });
                    
                    // Mark the stored preset as active
                    presetBtn.classList.add('preset-active');
                    
                    console.log(`🔄 Restored active preset indicator: ${activePreset}`);
                }
            }
        }

        // Clear active preset when user makes manual changes
        function clearActivePreset() {
            localStorage.removeItem('activePreset');
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.classList.remove('preset-active');
            });
        }

        // Monitor for manual changes that should clear preset status
        function monitorConfigurationChanges() {
            // Monitor template type changes
            const templateSelect = document.getElementById('templateTypeSelect');
            if (templateSelect) {
                templateSelect.addEventListener('change', () => {
                    const activePreset = localStorage.getItem('activePreset');
                    if (activePreset) {
                        const currentPreset = SMART_PRESETS[activePreset];
                        if (currentPreset && templateSelect.value !== currentPreset.templateType) {
                            clearActivePreset();
                            showToast('Preset cleared due to manual changes', 'info');
                        }
                    }
                });
            }

            // Monitor main prompt changes
            const mainPrompt = document.getElementById('mainPrompt');
            if (mainPrompt) {
                let promptChangeTimer;
                mainPrompt.addEventListener('input', () => {
                    clearTimeout(promptChangeTimer);
                    promptChangeTimer = setTimeout(() => {
                        const activePreset = localStorage.getItem('activePreset');
                        if (activePreset) {
                            const currentPreset = SMART_PRESETS[activePreset];
                            if (currentPreset && mainPrompt.value !== currentPreset.mainPrompt) {
                                clearActivePreset();
                                showToast('Preset cleared due to prompt changes', 'info');
                            }
                        }
                    }, 2000); // Wait 2 seconds after user stops typing
                });
            }
        }

        // ============================================
        // INITIALIZE ALL ENHANCED FEATURES
        // ============================================

        // Initialize enhanced features after DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                initializeAutoSave();
                initializeAdvancedOptions();
                initializeEnhancedButtonGroups();
                initializeConfigurationManagement();
                loadAutoSavedConfiguration();
                restoreActivePreset();
                monitorConfigurationChanges();
                
                console.log('🚀 Enhanced Template Builder features initialized!');
            }, 1000);
        });

        // ============================================
        // AI GENERATION LOGIC
        // ============================================

        const SYSTEM_PROMPT_2 = `You are a professional Tailwind CSS designer. Create HTML designs that EXACTLY match the prompt requirements while being visually appealing and modern.

📋 TECHNICAL REQUIREMENTS:
- Use only HTML, Tailwind CSS, and minimal JavaScript
- Include Tailwind CSS CDN: https://cdn.tailwindcss.com
- Enclose everything within <html>...</html> tags (no content outside)
- Add appropriate icon libraries if needed (Heroicons, Lucide, Font Awesome)
- Use custom CSS in <style> tags only when Tailwind is insufficient
- Ensure responsive design with mobile-first approach

🎯 DESIGN APPROACH:
- Follow the prompt specifications precisely - this is critical
- Identify the core purpose and target audience from the prompt
- Create layouts that serve the stated business objectives
- Use modern, clean design principles while staying true to requirements
- Ensure excellent user experience and accessibility
- Make it visually appealing while maintaining functional focus

⚠️ IMPORTANT: Accuracy to the prompt requirements is more important than creative interpretation. The design must solve the specific problem or serve the specific purpose mentioned in the prompt.`;

        async function generateHtmlDesign(prompt, apiKey, model, creativityLevel = 5) {
            try {
                // Calculate temperature for design generation based on creativity level
                const designTemperature = Math.min(1.0, Math.max(0.3, (creativityLevel - 1) * 0.08 + 0.4));
                
                console.log('🎨 Generating HTML design:', { prompt, model, designTemperature });

                // Enhanced system prompt to ensure adherence to user prompt
                const enhancedSystemPrompt = `${SYSTEM_PROMPT_2}

🚨 CRITICAL REQUIREMENTS:
1. STRICTLY follow the provided prompt specifications
2. NEVER ignore or deviate from the core concept in the prompt
3. If the prompt specifies a particular industry, purpose, or target audience, MAINTAIN it exactly
4. Every design element must serve the purpose specified in the prompt
5. The final HTML must directly address the requirements mentioned in the prompt

⚠️ VALIDATION CHECK: Before generating HTML, ask yourself:
- Does this design serve the exact purpose specified in the prompt?
- Have I included all the sections and features mentioned?
- Does the visual design match the industry and target audience specified?
- Am I solving the specific problem mentioned in the prompt?

If any answer is NO, revise the design to strictly match the prompt requirements.`;
                
                const messages = [
                    {
                        role: "system",
                        content: enhancedSystemPrompt
                    },
                    {
                        role: "user",
                        content: `CRITICAL: Create HTML that EXACTLY matches this specification:

${prompt}

MANDATORY VERIFICATION:
- Identify the core concept from the prompt above
- Ensure every design element serves this specific purpose  
- Include all sections and features mentioned in the prompt
- Use appropriate visual design for the specified industry/audience
- The final website must directly address the requirements in the prompt

Generate the complete HTML now:`
                    }
                ];

                const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json',
                        'HTTP-Referer': window.location.href,
                        'X-Title': 'Template Builder'
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: messages,
                        temperature: designTemperature,
                        max_tokens: 12000,
                        top_p: 0.95
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`API request failed with status ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                const rawHtml = data.choices[0].message.content;
                
                console.log('✅ HTML generated successfully, length:', rawHtml.length);

                return extractHtmlFromResponse(rawHtml);
                
            } catch (error) {
                console.error('❌ HTML generation failed:', error);
                throw error;
            }
        }

        function extractHtmlFromResponse(response) {
            // 1. Try to extract from code block first
            const codeBlockMatch = response.match(/```(?:html)?\s*([\s\S]*?)```/i);
            if (codeBlockMatch) {
                // Remove any leading text before <html or <!DOCTYPE
                const htmlStart = codeBlockMatch[1].search(/<html|<!DOCTYPE/i);
                if (htmlStart !== -1) {
                    return codeBlockMatch[1].slice(htmlStart).trim();
                }
                return codeBlockMatch[1].trim();
            }
            // 2. If no code block, find the first <html or <!DOCTYPE
            const htmlStart = response.search(/<html|<!DOCTYPE/i);
            if (htmlStart !== -1) {
                return response.slice(htmlStart).trim();
            }
            // 3. Fallback: return the whole response
            return response.trim();
        }
    </script>
</body>
</html>